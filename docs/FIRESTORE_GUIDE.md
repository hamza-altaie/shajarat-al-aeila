# ุฏููู Firestore - ุดุฌุฑุฉ ุงูุนุงุฆูุฉ

## ๐ฅ Firebase Firestore Integration Guide

ุชู ุฑุจุท ุงููุดุฑูุน ุจูุฌุงุญ ูุน Firebase Firestore ููุงุนุฏุฉ ุจูุงูุงุช ุฑุฆูุณูุฉ ูุชุฎุฒูู ุจูุงูุงุช ุงูุนุงุฆูุฉ ูุงููุณุชุฎุฏููู.

## ๐ ูููู ูุงุนุฏุฉ ุงูุจูุงูุงุช

### 1. ูุฌููุนุฉ ุงููุณุชุฎุฏููู (users)
```
users/{userId}
โโโ uid: string                 // ูุนุฑู ุงููุณุชุฎุฏู ูู Firebase Auth
โโโ phoneNumber: string         // ุฑูู ุงููุงุชู
โโโ createdAt: timestamp       // ุชุงุฑูุฎ ุงูุฅูุดุงุก
โโโ lastLogin: timestamp       // ุขุฎุฑ ุชุณุฌูู ุฏุฎูู
โโโ lastActive: timestamp      // ุขุฎุฑ ูุดุงุท
โโโ isTestUser: boolean        // ูุณุชุฎุฏู ุชุฌุฑูุจู (ุงุฎุชูุงุฑู)
```

### 2. ูุฌููุนุฉ ุฃูุฑุงุฏ ุงูุนุงุฆูุฉ (families)
```
families/{familyMemberId}
โโโ userId: string              // ูุนุฑู ุงููุณุชุฎุฏู ุงููุงูู
โโโ firstName: string           // ุงูุงุณู ุงูุฃูู
โโโ fatherName: string          // ุงุณู ุงูุฃุจ
โโโ grandfatherName: string     // ุงุณู ุงูุฌุฏ
โโโ surname: string             // ุงูููุจ
โโโ relation: string            // ุงููุฑุงุจุฉ
โโโ birthdate: string           // ุชุงุฑูุฎ ุงููููุงุฏ (YYYY-MM-DD)
โโโ avatar: string              // ุฑุงุจุท ุงูุตูุฑุฉ ุงูุดุฎุตูุฉ
โโโ parentId: string           // ูุนุฑู ุงููุงูุฏ (null ููุฌุฐุฑ)
โโโ manualParentName: string   // ุงุณู ุงููุงูุฏ ุงููุฏูู
โโโ linkedParentUid: string    // ุฑุจุท ูุน ูุณุชุฎุฏู ุขุฎุฑ
โโโ createdAt: timestamp       // ุชุงุฑูุฎ ุงูุฅูุดุงุก
โโโ updatedAt: timestamp       // ุชุงุฑูุฎ ุงูุชุญุฏูุซ
โโโ isTestMember: boolean      // ุนุถู ุชุฌุฑูุจู (ุงุฎุชูุงุฑู)
```

## โ๏ธ ุงูุฎุฏูุงุช ุงููุชุงุญุฉ

### ุฎุฏูุงุช ุงููุณุชุฎุฏู (userService.js)
```javascript
import { fetchUserData, createOrUpdateUser, updateUser, updateLastLogin } from './userService.js';

// ุฌูุจ ุจูุงูุงุช ุงููุณุชุฎุฏู
const userData = await fetchUserData(uid);

// ุฅูุดุงุก ุฃู ุชุญุฏูุซ ุงููุณุชุฎุฏู
const result = await createOrUpdateUser(uid, {
  phoneNumber: '+9647XXXXXXXX',
  // ... ุจูุงูุงุช ุฃุฎุฑู
});

// ุชุญุฏูุซ ุจูุงูุงุช ุงููุณุชุฎุฏู
await updateUser(uid, { lastActive: new Date() });

// ุชุญุฏูุซ ุขุฎุฑ ุชุณุฌูู ุฏุฎูู
await updateLastLogin(uid);
```

### ุฎุฏูุงุช ุงูุนุงุฆูุฉ (familyService.js)
```javascript
import { 
  loadFamily, 
  saveFamilyMemberData, 
  deleteFamilyMemberData,
  loadUnifiedFamilyTree,
  searchInUnifiedFamilyTree,
  validateMemberData,
  calculateAge
} from './services/familyService.js';

// ุฌูุจ ุฃูุฑุงุฏ ุงูุนุงุฆูุฉ
const familyMembers = await loadFamily(uid);

// ุญูุธ ุนุถู ุฌุฏูุฏ ุฃู ุชุญุฏูุซ ููุฌูุฏ
const savedMember = await saveFamilyMemberData(uid, {
  firstName: 'ุฃุญูุฏ',
  fatherName: 'ูุญูุฏ',
  grandfatherName: 'ุนูู',
  surname: 'ุงูุทุงุฆู',
  relation: 'ุงูุฃุจ',
  birthdate: '1980-01-01'
});

// ุญุฐู ุนุถู
await deleteFamilyMemberData(uid, memberId);

// ุงูุจุญุซ ูู ุงูุดุฌุฑุฉ
const searchResults = await searchInUnifiedFamilyTree('ุฃุญูุฏ');

// ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
const validation = validateMemberData(memberData);
if (!validation.isValid) {
  console.error('ุฃุฎุทุงุก:', validation.errors);
}

// ุญุณุงุจ ุงูุนูุฑ
const age = calculateAge('1980-01-01'); // "44 ุณูุฉ"
```

## ๐ ููุงุนุฏ ุงูุญูุงูุฉ (Security Rules)

ุชู ุฅุนุฏุงุฏ ููุงุนุฏ ุญูุงูุฉ ูุญููุฉ ูู ููู `firestore.rules`:

### ุญูุงูุฉ ุจูุงูุงุช ุงููุณุชุฎุฏููู
- ูู ูุณุชุฎุฏู ููููู ุงููุตูู ููุท ูุจูุงูุงุชู ุงูุดุฎุตูุฉ
- ุงููุตุงุฏูุฉ ูุทููุจุฉ ูุฌููุน ุงูุนูููุงุช

### ุญูุงูุฉ ุจูุงูุงุช ุงูุนุงุฆูุงุช
- ูู ูุณุชุฎุฏู ููููู ุงููุตูู ููุท ูุฃูุฑุงุฏ ุนุงุฆูุชู
- ุงูุชุญูู ูู `userId` ูู ุฌููุน ุงูุนูููุงุช
- ุงููุตุงุฏูุฉ ูุทููุจุฉ

### ุงูุดุฌุฑุฉ ุงูููุญุฏุฉ (ูุณุชูุจููุฉ)
- ูุฑุงุกุฉ ููุฌููุน (ุจุนุฏ ุงููุตุงุฏูุฉ)
- ูุชุงุจุฉ ููุท ูุตุงุญุจ ุงูุจูุงูุงุช

## ๐งช ุงุฎุชุจุงุฑ ุงูุงุชุตุงู

ููููู ุงุฎุชุจุงุฑ ุงูุงุชุตุงู ูุน Firestore ุนุจุฑ:

### 1. ุนุจุฑ ูุงุฌูุฉ ุงููุณุชุฎุฏู
```
ุงูุชูู ุฅูู: http://localhost:5175/firestore-test
```

### 2. ุนุจุฑ ุงูููุฏ ุงููุจุงุดุฑ
```javascript
import { testFirestoreConnection } from './utils/firestoreTest.js';

const results = await testFirestoreConnection(userUid);
console.log('ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ:', results);
```

## ๐ ุงููุคุดุฑุงุช ูุงูููุงุฑุณ ุงููุทููุจุฉ

### ููุงุฑุณ Firestore ุงููุทููุจุฉ:
1. **families collection:**
   - `userId` (Ascending) + `createdAt` (Descending)
   - `userId` (Ascending) + `updatedAt` (Descending)

### ุฅูุดุงุก ุงูููุงุฑุณ:
```bash
# ุณูุชู ุฅูุดุงุก ุงูููุงุฑุณ ุชููุงุฆูุงู ุนูุฏ ุฃูู ุงุณุชุนูุงู
# ุฃู ูููู ุฅูุดุงุคูุง ูุฏููุงู ูู Firebase Console
```

## ๐ง ุฅุนุฏุงุฏ Firebase Console

### 1. ุฅุนุฏุงุฏ ููุงุนุฏ ุงูุญูุงูุฉ
```bash
# ูู Firebase Console > Firestore Database > Rules
# ุงูุณุฎ ูุญุชูู ููู firestore.rules
```

### 2. ุฅูุดุงุก ุงููุฌููุนุงุช ุงูุฃูููุฉ
```javascript
// ุณุชููุดุฃ ุงููุฌููุนุงุช ุชููุงุฆูุงู ุนูุฏ ุฃูู ุงุณุชุฎุฏุงู
// ุฃู ูููู ุฅูุดุงุคูุง ูุฏููุงู:
// users (collection)
// families (collection)
```

### 3. ุชูุนูู Firestore
```bash
# ูู Firebase Console > Firestore Database
# ุงุฎุชุฑ "Create database"
# ุงุฎุชุฑ ูููุน ุงูุฎุงุฏู (eur3 - Europe)
# ุงุจุฏุฃ ูู ูุถุน ุงูุงุฎุชุจุงุฑ ุซู ุทุจู ุงูููุงุนุฏ
```

## ๐ ุงูุฃุฏุงุก ูุงูุชุญุณูู

### ูุตุงุฆุญ ุงูุฃุฏุงุก:
1. **ุงุณุชุฎุฏุงู ุงูููุงุฑุณ:** ุฌููุน ุงูุงุณุชุนูุงูุงุช ูููุฑุณุฉ
2. **ุชูููู ุนูููุงุช ุงููุฑุงุกุฉ:** ุงุณุชุฎุฏุงู cache ูุญูู
3. **ุงูุจุญุซ ุงููุญุณู:** ุงุณุชุนูุงูุงุช ูุญุฏุฏุฉ ุจุฏูุงู ูู scan ูุงูู
4. **ุชุญุฏูุซุงุช ูุฌูุนุฉ:** ุงุณุชุฎุฏุงู batch operations ุนูุฏ ุงูุญุงุฌุฉ

### ูุฑุงูุจุฉ ุงูุงุณุชุฎุฏุงู:
```bash
# ูู Firebase Console > Firestore Database > Usage
# ูุฑุงูุจุฉ ุนุฏุฏ ุงููุฑุงุกุงุช/ุงููุชุงุจุงุช/ุงูุญุฐู ููููุงู
```

## ๐ ุงูููุฒุงุช ุงููุณุชูุจููุฉ

### 1. ุงูุดุฌุฑุฉ ุงูููุญุฏุฉ
- ุฑุจุท ุฃุดุฌุงุฑ ุงูุนูุงุฆู ุงููุฎุชููุฉ
- ุงูุจุญุซ ุงูุดุงูู ุนุจุฑ ุฌููุน ุงููุณุชุฎุฏููู
- ุชุญููู ุงูุฑูุงุจุท ุงูุนุงุฆููุฉ

### 2. ุงูุจุญุซ ุงููุชูุฏู
- ุจุญุซ ูุตู ูุชุทูุฑ
- ููุชุฑุฉ ุญุณุจ ุงูุชูุงุฑูุฎ ูุงูุฃุนูุงุฑ
- ุงูุจุญุซ ุงูุฌุบุฑุงูู

### 3. ุงูุฅุญุตุงุฆูุงุช ุงููุชูุฏูุฉ
- ุชุญููู ุงูุฃูุณุงุจ
- ุฎุฑุงุฆุท ุงูุชูุฒูุน ุงูุนุงุฆูู
- ุฅุญุตุงุฆูุงุช ุฏูููุบุฑุงููุฉ

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ูุดุงูู ุดุงุฆุนุฉ ูุญููููุง:

#### ุฎุทุฃ ูู ุงูุตูุงุญูุงุช:
```
Error: Missing or insufficient permissions
```
**ุงูุญู:** ุชุญูู ูู ููุงุนุฏ ุงูุญูุงูุฉ ูุฃู ุงููุณุชุฎุฏู ูุตุงุฏู ุนููู

#### ุฎุทุฃ ูู ุงูููุงุฑุณ:
```
Error: The query requires an index
```
**ุงูุญู:** ุฅูุดุงุก ุงูููุฑุณ ุงููุทููุจ ูู Firebase Console

#### ุฎุทุฃ ูู ุงูุดุจูุฉ:
```
Error: Network error
```
**ุงูุญู:** ุชุญูู ูู ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช ูุฅุนุฏุงุฏุงุช Firebase

## ๐ ุงูุฏุนู

ููุญุตูู ุนูู ุงููุณุงุนุฏุฉ:
1. ุฑุงุฌุน [ูุซุงุฆู Firebase Firestore](https://firebase.google.com/docs/firestore)
2. ุชุญูู ูู Console ุงููุชุตูุญ ููุฃุฎุทุงุก
3. ุงุณุชุฎุฏู ุตูุญุฉ ุงุฎุชุจุงุฑ Firestore ุงููุฏูุฌุฉ
4. ุฑุงุฌุน ูููุงุช ุงูุฎุฏูุงุช ููุฃูุซูุฉ ุงูุนูููุฉ
