rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===========================================================
    // ðŸ” Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ù…Ø§Ù† Ø¥Ù†ØªØ§Ø¬ÙŠØ© ÙƒØ§Ù…Ù„Ø© ÙˆØ¢Ù…Ù†Ø© Ù„Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©
    // ===========================================================
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ù„ÙƒÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
    function hasValidPhone(phoneNumber) {
      return phoneNumber != null && 
             phoneNumber is string && 
             phoneNumber.size() >= 10 && 
             phoneNumber.size() <= 20 &&
             phoneNumber.matches('^\\+[0-9]+$');
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    function isValidUserData(data) {
      return data.keys().hasAll(['phone', 'createdAt']) &&
             hasValidPhone(data.phone) &&
             data.createdAt is timestamp;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©
    function isValidFamilyMember(data) {
      return data.keys().hasAll(['firstName', 'relation']) &&
             data.firstName is string &&
             data.firstName.size() >= 2 &&
             data.firstName.size() <= 50 &&
             data.relation is string &&
             data.relation in ['Ø±Ø¨ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©', 'Ø§Ø¨Ù†', 'Ø¨Ù†Øª', 'Ø£Ø®', 'Ø£Ø®Øª', 
                              'Ø§Ø¨Ù† Ø£Ø®', 'Ø¨Ù†Øª Ø£Ø®', 'Ø§Ø¨Ù† Ø£Ø®Øª', 'Ø¨Ù†Øª Ø£Ø®Øª',
                              'Ø­ÙÙŠØ¯', 'Ø­ÙÙŠØ¯Ø©', 'Ø¹Ù…', 'Ø¹Ù…Ø©', 'Ø®Ø§Ù„', 'Ø®Ø§Ù„Ø©'];
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©
    function isValidFamilyLink(data) {
      return data.keys().hasAll(['targetFamilyUid', 'linkType', 'createdAt']) &&
             data.targetFamilyUid is string &&
             data.linkType in ['parent-child', 'child-parent', 'sibling', 'marriage', 'cousin', 'extended'] &&
             data.createdAt is timestamp;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ø±Ø¨Ø·
    function allowsLinking(userData) {
      return userData.get('allowFamilyLinking', true) == true;
    }
    
    // ===========================================================
    // ðŸ“± Ù‚ÙˆØ§Ø¹Ø¯ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    // ===========================================================
    match /users/{userId} {
      // Ù‚Ø±Ø§Ø¡Ø©: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†ÙØ³Ù‡ + Ù‚Ø±Ø§Ø¡Ø© Ù…Ø­Ø¯ÙˆØ¯Ø© Ù„Ù„Ø¢Ø®Ø±ÙŠÙ† Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª
      allow read: if isAuthenticated() && (
        isOwner(userId) ||
        // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† ÙŠØ³Ù…Ø­ÙˆÙ† Ø¨Ø§Ù„Ø±Ø¨Ø·
        (resource != null && allowsLinking(resource.data))
      );
      
      // ÙƒØªØ§Ø¨Ø©: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†ÙØ³Ù‡ ÙÙ‚Ø· Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø´Ø§Ù…Ù„
      allow create: if isAuthenticated() && 
                       isOwner(userId) && 
                       isValidUserData(request.resource.data);
      
      allow update: if isAuthenticated() && 
                       isOwner(userId) && (
                         // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙÙ‚Ø·
                         request.resource.data.diff(resource.data).affectedKeys()
                           .hasOnly(['lastLogin', 'updatedAt', 'displayName', 'linkedFamilies', 'allowFamilyLinking']) &&
                         // Ù…Ù†Ø¹ ØªØºÙŠÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©
                         !request.resource.data.diff(resource.data).affectedKeys()
                           .hasAny(['uid', 'phone', 'createdAt'])
                       );
      
      // Ø­Ø°Ù: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†ÙØ³Ù‡ ÙÙ‚Ø·
      allow delete: if isAuthenticated() && isOwner(userId);
    }
    
    // ===========================================================
    // ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ Ù‚ÙˆØ§Ø¹Ø¯ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© - Ù…ÙØ­Ø³Ù†Ø© Ù„Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø±Ø¨Ø·
    // ===========================================================
    match /users/{userId}/family/{memberId} {
      // Ù‚Ø±Ø§Ø¡Ø©: ØµØ§Ø­Ø¨ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© + Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ø°ÙŠÙ† ÙŠØ¨Ø­Ø«ÙˆÙ† Ø¹Ù† Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª Ù„Ù„Ø±Ø¨Ø·
      allow read: if isAuthenticated() && (
        isOwner(userId) ||
        // Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡Ù… Ø¨Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ù„Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø±Ø¨Ø·
        // Ø´Ø±Ø· Ø£Ù† ÙŠÙƒÙˆÙ† ØµØ§Ø­Ø¨ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ø±Ø¨Ø·
        (exists(/databases/$(database)/documents/users/$(userId)) &&
         allowsLinking(get(/databases/$(database)/documents/users/$(userId)).data))
      );
      
      // ÙƒØªØ§Ø¨Ø©: ØµØ§Ø­Ø¨ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© ÙÙ‚Ø· Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø´Ø§Ù…Ù„
      allow create: if isAuthenticated() && 
                       isOwner(userId) && 
                       isValidFamilyMember(request.resource.data);
      
      allow update: if isAuthenticated() && 
                       isOwner(userId) && 
                       isValidFamilyMember(request.resource.data) &&
                       // Ù…Ù†Ø¹ ØªØºÙŠÙŠØ± Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ø¶Ùˆ ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡
                       !request.resource.data.diff(resource.data).affectedKeys()
                         .hasAny(['id', 'createdAt']);
      
      allow delete: if isAuthenticated() && isOwner(userId);
    }
    
    // ===========================================================
    // ðŸ”— Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø¨ÙŠÙ† Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª - Ù…Ø­Ø³Ù†Ø© ÙˆØ¢Ù…Ù†Ø©
    // ===========================================================
    match /family_connections/{connectionId} {
      // Ù‚Ø±Ø§Ø¡Ø©: Ø§Ù„Ø£Ø·Ø±Ø§Ù Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·
      allow read: if isAuthenticated() && 
                     resource != null && (
                       request.auth.uid == resource.data.family1Id ||
                       request.auth.uid == resource.data.family2Id
                     );
      
      // Ø¥Ù†Ø´Ø§Ø¡: Ø£Ø­Ø¯ Ø§Ù„Ø£Ø·Ø±Ø§Ù Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª ÙˆÙ…ÙˆØ§ÙÙ‚ØªÙ‡Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø¨Ø·
      allow create: if isAuthenticated() && (
        request.auth.uid == request.resource.data.family1Id ||
        request.auth.uid == request.resource.data.family2Id
      ) &&
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª
      exists(/databases/$(database)/documents/users/$(request.resource.data.family1Id)) &&
      exists(/databases/$(database)/documents/users/$(request.resource.data.family2Id)) &&
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª ØªØ³Ù…Ø­ Ø¨Ø§Ù„Ø±Ø¨Ø·
      allowsLinking(get(/databases/$(database)/documents/users/$(request.resource.data.family1Id)).data) &&
      allowsLinking(get(/databases/$(database)/documents/users/$(request.resource.data.family2Id)).data) &&
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      request.resource.data.keys().hasAll(['family1Id', 'family2Id', 'connectionType', 'createdAt']) &&
      request.resource.data.connectionType in ['parent-child', 'sibling', 'marriage', 'cousin', 'extended'];
      
      // ØªØ­Ø¯ÙŠØ«: Ø§Ù„Ø£Ø·Ø±Ø§Ù Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙ‚Ø· (Ù…Ù†Ø¹ ØªØºÙŠÙŠØ± Ø§Ù„Ù‡ÙˆÙŠØ§Øª)
      allow update: if isAuthenticated() && 
                       resource != null && (
                         request.auth.uid == resource.data.family1Id ||
                         request.auth.uid == resource.data.family2Id
                       ) &&
                       !request.resource.data.diff(resource.data).affectedKeys()
                         .hasAny(['family1Id', 'family2Id', 'createdAt']);
      
      // Ø­Ø°Ù: Ø£ÙŠ Ù…Ù† Ø§Ù„Ø·Ø±ÙÙŠÙ†
      allow delete: if isAuthenticated() && 
                      resource != null && (
                        request.auth.uid == resource.data.family1Id ||
                        request.auth.uid == resource.data.family2Id
                      );
    }
    
    // ===========================================================
    // ðŸ“Š Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    // ===========================================================
    match /analytics/{userId} {
      allow read: if isAuthenticated() && isOwner(userId);
      allow write: if isAuthenticated() && 
                      isOwner(userId) &&
                      // Ù…Ù†Ø¹ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø´Ø®ØµÙŠØ© Ø­Ø³Ø§Ø³Ø©
                      !request.resource.data.keys()
                        .hasAny(['phoneNumbers', 'personalInfo', 'addresses', 'emails']);
    }
    
    // ===========================================================
    // ðŸ” Ù‚ÙˆØ§Ø¹Ø¯ ÙÙ‡Ø±Ø³ Ø§Ù„Ø¨Ø­Ø« (Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·)
    // ===========================================================
    match /search_index/{indexId} {
      allow read: if isAuthenticated();
      allow write: if false; // Cloud Functions ÙÙ‚Ø·
    }
    
    // ===========================================================
    // ðŸ“± Ù‚ÙˆØ§Ø¹Ø¯ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø§Øª
    // ===========================================================
    match /user_sessions/{userId}/sessions/{sessionId} {
      allow read: if isAuthenticated() && isOwner(userId);
      allow create: if isAuthenticated() && 
                       isOwner(userId) &&
                       request.resource.data.keys()
                         .hasAll(['deviceInfo', 'loginTime', 'lastActivity']);
      
      allow update: if isAuthenticated() && 
                       isOwner(userId) &&
                       request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['lastActivity', 'isActive']);
      
      allow delete: if isAuthenticated() && isOwner(userId);
    }
    
    // ===========================================================
    // ðŸš¨ Ù‚ÙˆØ§Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙˆØ§Ù„ØªØ¯Ù‚ÙŠÙ‚
    // ===========================================================
    match /audit_logs/{userId}/logs/{logId} {
      allow read: if isAuthenticated() && isOwner(userId);
      allow write: if false; // Cloud Functions ÙÙ‚Ø·
    }
    
    // ===========================================================
    // ðŸ”„ Ù‚ÙˆØ§Ø¹Ø¯ Ø°Ø§ÙƒØ±Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
    // ===========================================================
    match /cache/{userId}/{cacheId} {
      allow read: if isAuthenticated() && isOwner(userId);
      allow write: if isAuthenticated() && 
                      isOwner(userId) &&
                      // Ø§Ù†ØªÙ‡Ø§Ø¡ ØµÙ„Ø§Ø­ÙŠØ© Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©
                      request.resource.data.expiresAt > request.time &&
                      request.resource.data.expiresAt < request.time + duration.value(1, 'd');
      
      // Ø­Ø°Ù ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
      allow delete: if isAuthenticated() && (
        isOwner(userId) ||
        (resource != null && resource.data.expiresAt < request.time)
      );
    }
    
    // ===========================================================
    // ðŸŽ­ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ù„Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø­ÙŠØ©
    // ===========================================================
    match /live_activities/{activityId} {
      // Ù‚Ø±Ø§Ø¡Ø© Ù„Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† ÙÙŠ Ø§Ù„Ù†Ø´Ø§Ø·
      allow read: if isAuthenticated() && 
        resource != null && request.auth.uid in resource.data.get('participants', []);
      
      // ÙƒØªØ§Ø¨Ø© Ù„Ù„Ù…Ù†Ø´Ø¦ ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†
      allow write: if isAuthenticated() && (
        request.resource.data.get('createdBy', '') == request.auth.uid ||
        (resource != null && (
          request.auth.uid == resource.data.get('createdBy', '') ||
          request.auth.uid in resource.data.get('participants', [])
        ))
      ) && 
      // Ø§Ù†ØªÙ‡Ø§Ø¡ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù†Ø´Ø§Ø· Ø®Ù„Ø§Ù„ Ø³Ø§Ø¹Ø© ÙˆØ§Ø­Ø¯Ø©
      request.resource.data.expiresAt < request.time + duration.value(1, 'h');
    }
    
    // ===========================================================
    // ðŸ”’ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø© - Ø±ÙØ¶ ÙƒÙ„ Ø´ÙŠØ¡ Ø¢Ø®Ø±
    // ===========================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}