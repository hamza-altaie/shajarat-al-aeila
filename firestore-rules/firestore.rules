rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Ø§Ù„Ø¯ÙˆØ§Ù„ ÙƒÙ…Ø§ Ù‡ÙŠ...
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isValidUserData(data) {
      // Ø§Ù„Ø³Ù…Ø§Ø­ Ù…Ø¤Ù‚ØªÙ‹Ø§ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³ØªØ®Ø¯Ù… (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±)
      return true;
    }
    
    // ===========================================================
    // ğŸ“± Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† - Ù…Ø¹ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù‚Ø±Ø§Ø¡Ø© Ù…Ø­Ø¯ÙˆØ¯Ø© Ù„Ù„Ø¢Ø®Ø±ÙŠÙ†
    // ===========================================================
    
    match /users/{userId} {
      // Ù‚Ø±Ø§Ø¡Ø©: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†ÙØ³Ù‡ + Ù‚Ø±Ø§Ø¡Ø© Ù…Ø­Ø¯ÙˆØ¯Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡Ù…
      allow read: if isAuthenticated() && (
        isOwner(userId) ||
        // Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡Ù… Ø¨Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙÙ‚Ø·
        isAuthenticated()
      );
      
      // Ø¥Ù†Ø´Ø§Ø¡: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†ÙØ³Ù‡ ÙÙ‚Ø·
      allow create: if isAuthenticated() && 
                       isOwner(userId) && 
                       isValidUserData(request.resource.data);
      
      // ØªØ­Ø¯ÙŠØ«: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†ÙØ³Ù‡ ÙÙ‚Ø·
      allow update: if isAuthenticated();
      
      // Ø­Ø°Ù: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†ÙØ³Ù‡ ÙÙ‚Ø·
      allow delete: if isAuthenticated() && isOwner(userId);
    }
    
    // ===========================================================
    // ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© - Ù…Ø¹ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù‚Ø±Ø§Ø¡Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡Ù…
    // ===========================================================
    
    match /users/{userId}/family/{memberId} {
      // Ù‚Ø±Ø§Ø¡Ø©: ØµØ§Ø­Ø¨ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© + Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡Ù… (Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª)
      allow read: if isAuthenticated() && (
        isOwner(userId) ||
        // Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡Ù… Ø¨Ù‚Ø±Ø§Ø¡Ø© Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª Ù„Ù„Ø±Ø¨Ø·
        isAuthenticated()
      );
      
      // Ø¥Ù†Ø´Ø§Ø¡/ØªØ­Ø¯ÙŠØ«/Ø­Ø°Ù: ØµØ§Ø­Ø¨ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© ÙÙ‚Ø·
      allow create, update, delete: if isAuthenticated() && 
                                       isOwner(userId);
    }
    
    // ===========================================================
    // ğŸ  Ù‚ÙˆØ§Ø¹Ø¯ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª Ø§Ù„Ù…Ø³Ø·Ø­Ø© (Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„ÙŠ)
    // ===========================================================
    
    match /families/{familyId} {
      // Ù‚Ø±Ø§Ø¡Ø©: Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡Ù… (Ù„Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø´Ø¬Ø±Ø© Ø§Ù„Ù…ÙˆØ­Ø¯Ø©)
      allow read: if isAuthenticated();
      
      // Ø¥Ù†Ø´Ø§Ø¡: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡Ù… ÙÙ‚Ø·
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      
      // ØªØ­Ø¯ÙŠØ«: ØµØ§Ø­Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙ‚Ø·
      allow update: if isAuthenticated() && 
                       (resource == null || resource.data.userId == request.auth.uid);
      
      // Ø­Ø°Ù: ØµØ§Ø­Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙ‚Ø·
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
    }
    
    // ===========================================================
    // ğŸ§ª Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
    // ===========================================================
    
    match /test_connection/{testId} {
      // Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡Ù… Ø¨Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
      allow read, write: if isAuthenticated();
    }
    
    // ===========================================================
    // ğŸ›ï¸ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù‚Ø¨Ø§Ø¦Ù„ - Ø§Ù„Ø´Ø¬Ø±Ø© Ø§Ù„Ù…ÙˆØ­Ø¯Ø©
    // ===========================================================
    
    // Ù‚Ø±Ø§Ø¡Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚Ø¨Ø§Ø¦Ù„ Ø§Ù„Ø¹Ø§Ù…Ø©
    match /tribes/{tribeId} {
      // Ù‚Ø±Ø§Ø¡Ø©: Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡Ù… ÙŠÙ…ÙƒÙ†Ù‡Ù… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚Ø¨Ø§Ø¦Ù„
      allow read: if isAuthenticated();
      
      // Ø¥Ù†Ø´Ø§Ø¡: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡Ù… ÙÙ‚Ø·
      allow create: if isAuthenticated() && 
                       request.resource.data.createdBy == request.auth.uid;
      
      // ØªØ­Ø¯ÙŠØ«: Ù…Ù†Ø´Ø¦ Ø§Ù„Ù‚Ø¨ÙŠÙ„Ø© Ø£Ùˆ Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙÙ‚Ø·
      allow update: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isTribeModerator(tribeId)
      );
      
      // Ø­Ø°Ù: Ù…Ù†Ø´Ø¦ Ø§Ù„Ù‚Ø¨ÙŠÙ„Ø© ÙÙ‚Ø·
      allow delete: if isAuthenticated() && 
                       resource.data.createdBy == request.auth.uid;
    }
    
    // Ø¹Ø¶ÙˆÙŠØ© Ø§Ù„Ù‚Ø¨Ø§Ø¦Ù„
    match /tribeMemberships/{membershipId} {
      // Ù‚Ø±Ø§Ø¡Ø©: Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡Ù…
      allow read: if isAuthenticated();
      
      // Ø¥Ù†Ø´Ø§Ø¡: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡Ù… ÙÙ‚Ø·
      allow create: if isAuthenticated();
      
      // ØªØ­Ø¯ÙŠØ«: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡Ù… ÙÙ‚Ø·
      allow update: if isAuthenticated();
      
      // Ø­Ø°Ù: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡Ù… ÙÙ‚Ø·
      allow delete: if isAuthenticated();
    }
    
    // Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù‚Ø¨ÙŠÙ„Ø©
    match /tribes/{tribeId}/members/{memberId} {
      // Ù‚Ø±Ø§Ø¡Ø©: Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡Ù…
      allow read: if isAuthenticated();
      
      // Ø¥Ù†Ø´Ø§Ø¡/ØªØ­Ø¯ÙŠØ«: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡Ù… ÙÙ‚Ø·
      allow create, update: if isAuthenticated();
      
      // Ø­Ø°Ù: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡Ù… ÙÙ‚Ø·
      allow delete: if isAuthenticated();
    }
    
    // Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ù‚Ø¨ÙŠÙ„Ø©
    match /tribeJoinRequests/{requestId} {
      // Ù‚Ø±Ø§Ø¡Ø©: Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡Ù…
      allow read: if isAuthenticated();
      
      // Ø¥Ù†Ø´Ø§Ø¡: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡Ù… ÙÙ‚Ø·
      allow create: if isAuthenticated();
      
      // ØªØ­Ø¯ÙŠØ«: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡Ù… ÙÙ‚Ø·
      allow update: if isAuthenticated();
      
      // Ø­Ø°Ù: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡Ù… ÙÙ‚Ø·
      allow delete: if isAuthenticated();
    }
    
    // Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª ÙÙŠ Ø§Ù„Ù‚Ø¨ÙŠÙ„Ø©
    match /tribes/{tribeId}/connections/{connectionId} {
      // Ù‚Ø±Ø§Ø¡Ø©: Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡Ù…
      allow read: if isAuthenticated();
      
      // Ø¥Ù†Ø´Ø§Ø¡/ØªØ­Ø¯ÙŠØ«: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡Ù… ÙÙ‚Ø·
      allow create, update: if isAuthenticated();
      
      // Ø­Ø°Ù: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡Ù… ÙÙ‚Ø·
      allow delete: if isAuthenticated();
    }
    
    // ===========================================================
    // ğŸ”§ Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ù‚Ø¨Ø§Ø¦Ù„
    // ===========================================================
    
    function isTribeMember(tribeId) {
      return exists(/databases/$(database)/documents/tribeMemberships/$(request.auth.uid + '_' + tribeId)) &&
             get(/databases/$(database)/documents/tribeMemberships/$(request.auth.uid + '_' + tribeId)).data.status == 'active';
    }
    
    function isTribeModerator(tribeId) {
      return exists(/databases/$(database)/documents/tribeMemberships/$(request.auth.uid + '_' + tribeId)) &&
             get(/databases/$(database)/documents/tribeMemberships/$(request.auth.uid + '_' + tribeId)).data.status == 'active' &&
             get(/databases/$(database)/documents/tribeMemberships/$(request.auth.uid + '_' + tribeId)).data.role in ['admin', 'moderator'];
    }
    
    function canEditTribeMembers(tribeId) {
      return exists(/databases/$(database)/documents/tribeMemberships/$(request.auth.uid + '_' + tribeId)) &&
             get(/databases/$(database)/documents/tribeMemberships/$(request.auth.uid + '_' + tribeId)).data.status == 'active' &&
             get(/databases/$(database)/documents/tribeMemberships/$(request.auth.uid + '_' + tribeId)).data.permissions.canEditMembers == true;
    }
    
    // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ...
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
