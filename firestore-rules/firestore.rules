rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // =======================================================
    // ðŸ” Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ù…Ø§Ù† Ù…ØªÙ‚Ø¯Ù…Ø© Ù„Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© 2025 - Ù…ÙØµØ­Ø­Ø©
    // =======================================================
    
    // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ù„ÙƒÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ÙˆØ«ÙŠÙ‚Ø©
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©
    function isValidUserData(data) {
      return data.keys().hasAll(['phone', 'createdAt']) &&
             data.phone is string &&
             data.createdAt is timestamp;
    }
    
    // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©
    function isValidFamilyMember(data) {
      return data.keys().hasAll(['firstName', 'relation']) &&
             data.firstName is string &&
             data.firstName.size() >= 2 &&
             data.firstName.size() <= 50 &&
             data.relation is string;
    }
    
    // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø©
    function isValidRelation(relation) {
      return relation in ['Ø±Ø¨ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©', 'Ø§Ø¨Ù†', 'Ø¨Ù†Øª', 'Ø£Ø®', 'Ø£Ø®Øª', 
                         'Ø§Ø¨Ù† Ø£Ø®', 'Ø¨Ù†Øª Ø£Ø®', 'Ø§Ø¨Ù† Ø£Ø®Øª', 'Ø¨Ù†Øª Ø£Ø®Øª',
                         'Ø­ÙÙŠØ¯', 'Ø­ÙÙŠØ¯Ø©', 'Ø¹Ù…', 'Ø¹Ù…Ø©', 'Ø®Ø§Ù„', 'Ø®Ø§Ù„Ø©'];
    }
    
    // Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ UIDs Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ø±ØªØ¨Ø·ÙŠÙ†
    function getLinkedMemberUIDs(linkedMembers) {
      return linkedMembers != null ? 
        linkedMembers.map('uid') : [];
    }
    
    // =======================================================
    // ðŸ“± Ù‚ÙˆØ§Ø¹Ø¯ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    // =======================================================
    match /users/{userId} {
      // Ù‚Ø±Ø§Ø¡Ø©: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†ÙØ³Ù‡ Ø£Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù…Ø±ØªØ¨Ø·ÙˆÙ†
      allow read: if isAuthenticated() && (
        isOwner(userId) ||
        // Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø±ØªØ¨Ø·ÙŠÙ† Ø¨Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        (resource != null && resource.data.get('allowLinking', false) == true) ||
        // Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ø¹Ø§Ø¦Ù„Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© - Ù…ÙØµØ­Ø­
        (resource != null && request.auth.uid in getLinkedMemberUIDs(resource.data.get('linkedMembers', [])))
      );
      
      // ÙƒØªØ§Ø¨Ø©: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†ÙØ³Ù‡ ÙÙ‚Ø· Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      allow write: if isAuthenticated() && isOwner(userId) && (
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastLogin', 'updatedAt']) ||
         isValidUserData(request.resource.data)) &&
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ÙˆØ¯
        request.resource.data.phone.size() >= 10 &&
        request.resource.data.phone.size() <= 20 &&
        
        // Ù…Ù†Ø¹ ØªØºÙŠÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø© Ø¥Ù„Ø§ Ø¨Ø´Ø±ÙˆØ· Ù…Ø¹ÙŠÙ†Ø©
        (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['uid', 'createdAt']) ||
         !exists(/databases/$(database)/documents/users/$(userId)))
      );
      
      // Ø­Ø°Ù: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†ÙØ³Ù‡ ÙÙ‚Ø·
      allow delete: if isAuthenticated() && isOwner(userId);
    }
    
    // =======================================================
    // ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ Ù‚ÙˆØ§Ø¹Ø¯ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©
    // =======================================================
    match /users/{userId}/family/{memberId} {
      // Ù‚Ø±Ø§Ø¡Ø©: ØµØ§Ø­Ø¨ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø£Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù…Ø±ØªØ¨Ø·ÙˆÙ†
      allow read: if isAuthenticated() && (
        isOwner(userId) ||
        // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù…Ø±ØªØ¨Ø·ÙˆÙ† ÙŠÙ…ÙƒÙ†Ù‡Ù… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('linkedToFamilyHead', '') == userId) ||
        
        // Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·ÙˆÙ† - Ù…ÙØµØ­Ø­
        (exists(/databases/$(database)/documents/users/$(userId)) &&
         request.auth.uid in getLinkedMemberUIDs(get(/databases/$(database)/documents/users/$(userId)).data.get('linkedMembers', [])))
      );
      
      // ÙƒØªØ§Ø¨Ø©: ØµØ§Ø­Ø¨ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø´Ø§Ù…Ù„
      allow create: if isAuthenticated() && isOwner(userId) &&
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        isValidFamilyMember(request.resource.data) &&
        isValidRelation(request.resource.data.relation);
      
      allow update: if isAuthenticated() && isOwner(userId) &&
        isValidFamilyMember(request.resource.data) &&
        isValidRelation(request.resource.data.relation) &&
        
        // Ù…Ù†Ø¹ ØªØºÙŠÙŠØ± Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ø¶Ùˆ
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['id', 'createdAt']);
      
      allow delete: if isAuthenticated() && isOwner(userId);
    }
    
    // =======================================================
    // ðŸ”— Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª ÙˆØ§Ù„Ø±ÙˆØ§Ø¨Ø· Ø¨ÙŠÙ† Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª
    // =======================================================
    match /family_connections/{connectionId} {
      // Ù‚Ø±Ø§Ø¡Ø©: Ø§Ù„Ø£Ø·Ø±Ø§Ù Ø§Ù„Ù…Ø¹Ù†ÙŠØ© Ø¨Ø§Ù„Ø§ØªØµØ§Ù„
      allow read: if isAuthenticated() && (
        resource != null && (
          request.auth.uid == resource.data.family1Id ||
          request.auth.uid == resource.data.family2Id ||
          // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù…Ø±ØªØ¨Ø·ÙˆÙ†
          request.auth.uid in resource.data.get('allowedUsers', [])
        )
      );
      
      // ÙƒØªØ§Ø¨Ø©: Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ Ø¬Ø¯ÙŠØ¯ Ø¨Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø·Ø±ÙÙŠÙ†
      allow create: if isAuthenticated() && (
        (request.auth.uid == request.resource.data.family1Id ||
         request.auth.uid == request.resource.data.family2Id) &&
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª
        exists(/databases/$(database)/documents/users/$(request.resource.data.family1Id)) &&
        exists(/databases/$(database)/documents/users/$(request.resource.data.family2Id)) &&
        
        // Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©
        request.resource.data.keys().hasAll(['family1Id', 'family2Id', 'connectionType', 'createdAt']) &&
        request.resource.data.connectionType in ['parent-child', 'sibling', 'extended']
      );
      
      // ØªØ­Ø¯ÙŠØ«: Ø§Ù„Ø£Ø·Ø±Ø§Ù Ø§Ù„Ù…Ø¹Ù†ÙŠØ© ÙÙ‚Ø·
      allow update: if isAuthenticated() && (
        resource != null && (
          request.auth.uid == resource.data.family1Id ||
          request.auth.uid == resource.data.family2Id
        ) && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['family1Id', 'family2Id', 'createdAt'])
      );
      
      // Ø­Ø°Ù: Ø£ÙŠ Ù…Ù† Ø§Ù„Ø·Ø±ÙÙŠÙ†
      allow delete: if isAuthenticated() && (
        resource != null && (
          request.auth.uid == resource.data.family1Id ||
          request.auth.uid == resource.data.family2Id
        )
      );
    }
    
    // =======================================================
    // ðŸ“Š Ù‚ÙˆØ§Ø¹Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    // =======================================================
    match /analytics/{userId} {
      allow read: if isAuthenticated() && isOwner(userId);
      allow write: if isAuthenticated() && isOwner(userId) &&
        // Ù…Ù†Ø¹ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø´Ø®ØµÙŠØ© Ø­Ø³Ø§Ø³Ø© ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª
        !request.resource.data.keys().hasAny(['personalInfo', 'phoneNumbers', 'addresses']);
    }
    
    // =======================================================
    // ðŸ” Ù‚ÙˆØ§Ø¹Ø¯ ÙÙ‡Ø±Ø³ Ø§Ù„Ø¨Ø­Ø«
    // =======================================================
    match /search_index/{indexId} {
      allow read: if isAuthenticated();
      allow write: if false; // ÙŠØªÙ… Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙ‚Ø· Ù…Ù† Ø®Ù„Ø§Ù„ Cloud Functions
    }
    
    // =======================================================
    // ðŸ”„ Ù‚ÙˆØ§Ø¹Ø¯ Ø°Ø§ÙƒØ±Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
    // =======================================================
    match /cache/{userId}/{cacheId} {
      allow read: if isAuthenticated() && isOwner(userId);
      allow write: if isAuthenticated() && isOwner(userId) &&
        // Ø§Ù†ØªÙ‡Ø§Ø¡ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©
        request.resource.data.expiresAt > request.time &&
        request.resource.data.expiresAt < request.time + duration.value(24, 'h');
      
      // Ø­Ø°Ù ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
      allow delete: if isAuthenticated() && (
        isOwner(userId) ||
        (resource != null && resource.data.expiresAt < request.time)
      );
    }
    
    // =======================================================
    // ðŸ“± Ù‚ÙˆØ§Ø¹Ø¯ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø§Øª ÙˆØ§Ù„Ø£Ø¬Ù‡Ø²Ø©
    // =======================================================
    match /user_sessions/{userId}/sessions/{sessionId} {
      allow read: if isAuthenticated() && isOwner(userId);
      allow create: if isAuthenticated() && isOwner(userId) &&
        request.resource.data.keys().hasAll(['deviceInfo', 'loginTime', 'lastActivity']) &&
        request.resource.data.deviceInfo is map;
      
      allow update: if isAuthenticated() && isOwner(userId) &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastActivity', 'isActive']);
      
      allow delete: if isAuthenticated() && isOwner(userId);
    }
    
    // =======================================================
    // ðŸš¨ Ù‚ÙˆØ§Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙˆØ§Ù„ØªØ¯Ù‚ÙŠÙ‚
    // =======================================================
    match /audit_logs/{userId}/logs/{logId} {
      // Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø· Ù„Ù„Ù…Ø§Ù„Ùƒ
      allow read: if isAuthenticated() && isOwner(userId);
      
      // ÙƒØªØ§Ø¨Ø© Ù„Ù„Ù†Ø¸Ø§Ù… ÙÙ‚Ø· (Ù…Ù† Ø®Ù„Ø§Ù„ Cloud Functions)
      allow create: if false; // Ø³ÙŠØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡Ø§ Ø¹Ø¨Ø± Cloud Functions
    }
    
    // =======================================================
    // ðŸŽ­ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ù„Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø­ÙŠØ©
    // =======================================================
    match /live_activities/{activityId} {
      // Ù‚Ø±Ø§Ø¡Ø© Ù„Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† ÙÙŠ Ø§Ù„Ù†Ø´Ø§Ø·
      allow read: if isAuthenticated() && 
        resource != null && request.auth.uid in resource.data.get('participants', []);
      
      // ÙƒØªØ§Ø¨Ø© Ù„Ù„Ù…Ù†Ø´Ø¦ ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†
      allow write: if isAuthenticated() && (
        request.resource.data.get('createdBy', '') == request.auth.uid ||
        (resource != null && (
          request.auth.uid == resource.data.get('createdBy', '') ||
          request.auth.uid in resource.data.get('participants', [])
        ))
      ) && 
      // Ø§Ù†ØªÙ‡Ø§Ø¡ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù†Ø´Ø§Ø· Ø®Ù„Ø§Ù„ Ø³Ø§Ø¹Ø© ÙˆØ§Ø­Ø¯Ø©
      request.resource.data.expiresAt < request.time + duration.value(1, 'h');
    }
    
    // =======================================================
    // ðŸ”’ Ù‚ÙˆØ§Ø¹Ø¯ Ø¹Ø§Ù…Ø© - Ø±ÙØ¶ ÙƒÙ„ Ø´ÙŠØ¡ Ø¢Ø®Ø±
    // =======================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}