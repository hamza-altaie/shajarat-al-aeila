// src/components/FamilyTreeAdvanced.jsx - ุงููุณุฎุฉ ุงููุตุญุญุฉ ูุน ุงูุดุฌุฑุฉ ุงูููุณุนุฉ ุงูุญููููุฉ
import React, { useState, useEffect, useCallback, useRef } from 'react';
import * as d3 from 'd3';
import ReactDOM from 'react-dom';
import { useNavigate } from 'react-router-dom';
import {
  Box, Button, Typography, Alert, Snackbar, CircularProgress, 
  Chip, IconButton, Tooltip, Paper, LinearProgress, 
  Dialog, DialogTitle, DialogContent, DialogActions, Divider, 
  FormControlLabel, Switch, TextField, InputAdornment
} from '@mui/material';

// ุงุณุชูุฑุงุฏ ุงูุฃููููุงุช ุจุดูู ูููุตู ูุชุญุณูู ุงูุฃุฏุงุก
import AccountTreeIcon from '@mui/icons-material/AccountTree';
import PersonIcon from '@mui/icons-material/Person';
import CloseIcon from '@mui/icons-material/Close';
import RefreshIcon from '@mui/icons-material/Refresh';
import WarningIcon from '@mui/icons-material/Warning';
import LinkIcon from '@mui/icons-material/Link';
import PersonAddIcon from '@mui/icons-material/PersonAdd';

// ุงุณุชูุฑุงุฏ ุงููุธุงู ุงูุฐูู ููุฑุจุท ุงูุชููุงุฆู
import { SmartTribalLinking } from '../utils/SmartTribalLinking';
import SearchIcon from '@mui/icons-material/Search';

// ุงุณุชูุฑุงุฏุงุช Firebase
import { db } from '../firebase/config';
import { doc, getDoc, collection, getDocs } from 'firebase/firestore';

// ุงุณุชูุฑุงุฏ ุงูููููุงุช
import ExtendedFamilyLinking from './ExtendedFamilyLinking';
import './FamilyTreeAdvanced.css';
import BarChartIcon from '@mui/icons-material/BarChart';

export default function FamilyTreeAdvanced() {
  // ===========================================================================
  // ุงูุญุงูุงุช ุงูุฃุณุงุณูุฉ
  // ===========================================================================
  
  const [showExtendedTree, setShowExtendedTree] = useState(false);
  const [selectedNode, setSelectedNode] = useState(null);
  const [linkedFamilies, setLinkedFamilies] = useState([]);
  const [showLinkingPanel, setShowLinkingPanel] = useState(false);
  const [performanceMetrics, setPerformanceMetrics] = useState({
    loadTime: 0,
    personCount: 0,
    maxDepthReached: 0,
    memoryUsage: 0
  });
  const [snackbarOpen, setSnackbarOpen] = useState(false);
  const [snackbarMessage, setSnackbarMessage] = useState('');
  const [snackbarSeverity, setSnackbarSeverity] = useState('info');
  const [simpleTreeData, setSimpleTreeData] = useState(null);
  const [extendedTreeData, setExtendedTreeData] = useState(null);
  const [loading, setLoading] = useState(false);
  const [loadingStage, setLoadingStage] = useState('');
  const [loadingProgress, setLoadingProgress] = useState(0);
  const [searchQuery, setSearchQuery] = useState('');
  const [error, setError] = useState(null);
  
  const uid = localStorage.getItem('verifiedUid');
  const navigate = useNavigate();
  
  // ุงููุฑุงุฌุน ููู D3
  const svgRef = useRef(null);
  const containerRef = useRef(null);
  const reactRootsRef = useRef(new Map());

  // ===========================================================================
  // ุฏูุงู ูุณุงุนุฏุฉ ุซุงุจุชุฉ
  // ===========================================================================

// ๐ง ุฅุตูุงุญ ุจุณูุท ูู iPhone
  useEffect(() => {
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    if (isIOS) {
      const style = document.createElement('style');
      style.textContent = `
        svg {
          transform: translateZ(0) !important;
          opacity: 1 !important;
          visibility: visible !important;
          overflow: visible !important;
        }
        svg g, svg text, svg rect, svg circle {
          opacity: 1 !important;
          visibility: visible !important;
        }
      `;
      document.head.appendChild(style);
    }
  }, []);

  const sanitizeMemberData = (memberData) => {
    return {
      ...memberData,
      firstName: memberData.firstName?.trim() || '',
      fatherName: memberData.fatherName?.trim() || '',
      grandfatherName: memberData.grandfatherName?.trim() || '',
      surname: memberData.surname?.trim() || '',
      relation: memberData.relation?.trim() || 'ุนุถู'
    };
  };

  const findFamilyHead = (members) => {
    const head = members.find(m => m.relation === 'ุฑุจ ุงูุนุงุฆูุฉ');
    if (head) return head;
    
    const sorted = [...members].sort((a, b) => {
      const dateA = new Date(a.createdAt || 0);
      const dateB = new Date(b.createdAt || 0);
      return dateA - dateB;
    });
    
    return sorted[0] || members[0];
  };

  // ===========================================================================
  // ุฏูุงู ุฃุณุงุณูุฉ useCallback
  // ===========================================================================

  const buildFullName = useCallback((person) => {
    if (!person) return '';

    const parts = [
        person.firstName,
        person.fatherName,
        person.surname
    ].filter(part => part && part.trim() !== '');

    return parts.length > 0 ? parts.join(' ').trim() : '';
  }, []);

  const showSnackbar = useCallback((message, severity = 'info') => {
    setSnackbarMessage(message);
    setSnackbarSeverity(severity);
    setSnackbarOpen(true);
  }, []);

  const handleNodeClick = useCallback((nodeData) => {
    if (nodeData.action === 'edit') {
      // ููุทู ุงูุชุนุฏูู
    } else if (nodeData.action === 'view') {
      // ููุทู ุงูุนุฑุถ
    }
    
    setSelectedNode(nodeData);
  }, []);

  const monitorPerformance = useCallback((metrics) => {
    // ุฏูุฌ ุงูุฅุญุตุงุฆูุงุช ูู ุงููุงูุฐุฉ ุงูุนุงูุฉ ุฅู ูุฌุฏุช
    const globalMetrics = window.familyTreeMetrics || {};
    
    setPerformanceMetrics(prev => ({
      ...prev,
      ...metrics,
      maxDepthReached: Math.max(prev.maxDepthReached || 0, globalMetrics.maxDepthReached || 0, metrics.maxDepthReached || 0)
    }));
    
    // ุฑุณุงุฆู ุชุญุณูููุฉ ุจูุงุกู ุนูู ุงูุฃุฏุงุก
    if (metrics.personCount > 100) {
      showSnackbar(`๐ ุฃุฏุงุก ุงุณุชุซูุงุฆู! ุชู ุชุญููู ${metrics.personCount} ุดุฎุต ุจูุฌุงุญ`, 'success');
    } else if (metrics.personCount > 50) {
      showSnackbar(`โ ุชู ุชุญููู ${metrics.personCount} ุดุฎุต ุจูุฌุงุญ`, 'success');
    }
    
    if (metrics.familyCount > 5) {
      showSnackbar(`๐๏ธ ุดุฌุฑุฉ ูุจูุฑุฉ: ุชู ุฑุจุท ${metrics.familyCount} ุนุงุฆูุฉ`, 'info');
    } else if (metrics.familyCount > 1) {
      showSnackbar(`๐๏ธ ุชู ุฑุจุท ${metrics.familyCount} ุนุงุฆูุฉ`, 'info');
    }
    
    // ุชุชุจุน ุงูุนูู ุงููุญูู ูุน ุชูููู ูุชูุฏู ููุฃุฌูุงู
    const actualDepth = globalMetrics.maxDepthReached || metrics.maxDepthReached;
    if (actualDepth >= 15) {
      showSnackbar(`๐๏ธ ุดุฌุฑุฉ ูุจููุฉ ุนุธููุฉ! ${actualDepth} ุฌูู - ูุธุงู ูุชูุฏู ุฌุฏุงู`, 'success');
    } else if (actualDepth >= 10) {
      showSnackbar(`๐ณ ุดุฌุฑุฉ ุนูููุฉ ููุชุงุฒุฉ: ${actualDepth} ุฌูู`, 'success');
    } else if (actualDepth >= 5) {
      showSnackbar(`๐ฟ ุนูู ุฌูุฏ: ${actualDepth} ุฃุฌูุงู`, 'info');
    } else if (actualDepth >= 2) {
      showSnackbar(`๐จโ๐ฉโ๐งโ๐ฆ ุดุฌุฑุฉ ุนุงุฆููุฉ: ${actualDepth} ุฃุฌูุงู`, 'info');
    }
    
  }, [showSnackbar]);

  // ===========================================================================
  // ุฏูุงู ุงูุจูุงุก
  // ===========================================================================

  const buildSimpleTreeStructure = useCallback((familyMembers) => {
    if (!familyMembers || familyMembers.length === 0) {
      return null;
    }

    const head = findFamilyHead(familyMembers);
    if (!head) {
      return null;
    }

    const rootNode = {
      name: buildFullName(head),
      id: head.globalId,
      avatar: head.avatar || null,
      attributes: {
        ...head,
        isCurrentUser: true,
        treeType: 'simple',
        isExtended: false
      },
      children: []
    };

    const children = familyMembers.filter(m => 
      (m.relation === 'ุงุจู' || m.relation === 'ุจูุช' || m.relation === 'child') && 
      m.globalId !== head.globalId
    );

    children.forEach(child => {
      rootNode.children.push({
        name: buildFullName(child),
        id: child.globalId,
        avatar: child.avatar || null,
        attributes: {
          ...child,
          treeType: 'simple',
          isExtended: false
        },
        children: []
      });
    });

    return rootNode;
  }, [buildFullName]);

  const calculateTreeDepth = useCallback((node, currentDepth = 0) => {
    if (!node || !node.children || node.children.length === 0) {
      return currentDepth;
    }
    
    let maxDepth = currentDepth;
    node.children.forEach(child => {
      const childDepth = calculateTreeDepth(child, currentDepth + 1);
      maxDepth = Math.max(maxDepth, childDepth);
    });
    
    return maxDepth;
  }, []);

  // ุชุญููู ุงูุดุฌุฑุฉ ุงูููุณุนุฉ ุจุงุณุชุฎุฏุงู ุงููุธุงู ุงูุฐูู
  const loadExtendedTree = useCallback(async () => {
    if (!smartLinking) {
      console.error('โ SmartTribalLinking ุบูุฑ ูุชููุฑ');
      setErrorMessage('ุงููุธุงู ุงูุฐูู ุบูุฑ ูุชููุฑ');
      setIsLoading(false);
      return;
    }

    setIsLoading(true);
    setErrorMessage('');
    
    try {
      console.log('๐ง ุจุฏุก ุชุญููู ุงูุดุฌุฑุฉ ุงูุฐููุฉ ูููุณุชุฎุฏู:', uid);
      
      // ุงุณุชุฎุฏุงู ุงููุธุงู ุงูุฐูู ูุจูุงุก ุงูุดุฌุฑุฉ
      const smartTree = await smartLinking.buildSmartTribalTree(uid);
      
      if (smartTree && smartTree.nodes && smartTree.nodes.length > 0) {
        console.log('โ ุชู ุจูุงุก ุงูุดุฌุฑุฉ ุงูุฐููุฉ ุจูุฌุงุญ:', smartTree.nodes.length, 'ุดุฎุต');
        
        // ุชุนููู ุงูุดุฌุฑุฉ
        setTreeData(smartTree);
        setIsTreeLoaded(true);
        
        // ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช
        const totalNodes = smartTree.nodes.length;
        const totalFamilies = new Set(smartTree.nodes.map(n => n.familyUid)).size;
        const maxDepth = calculateSmartTreeDepth(smartTree);
        
        console.log('๐ ุฅุญุตุงุฆูุงุช ุงูุดุฌุฑุฉ ุงูุฐููุฉ:', {
          totalNodes,
          totalFamilies,
          maxDepth
        });
        
      } else {
        console.warn('โ๏ธ ุงูุดุฌุฑุฉ ุงูุฐููุฉ ูุงุฑุบุฉุ ุงูุนูุฏุฉ ููุนุฑุถ ุงูุจุณูุท');
        await loadSimpleTreeFallback();
      }
      
    } catch (error) {
      console.error('โ ุฎุทุฃ ูู ุชุญููู ุงูุดุฌุฑุฉ ุงูุฐููุฉ:', error);
      setErrorMessage('ุฎุทุฃ ูู ุชุญููู ุงูุดุฌุฑุฉ ุงูุฐููุฉ: ' + error.message);
      
      // ูุญุงููุฉ ุงูุนูุฏุฉ ููุนุฑุถ ุงูุจุณูุท
      await loadSimpleTreeFallback();
    } finally {
      setIsLoading(false);
    }
  }, [uid, smartLinking, calculateSmartTreeDepth]);

  // ุฏุงูุฉ ุงุญุชูุงุทูุฉ ููุนุฑุถ ุงูุจุณูุท
  const loadSimpleTreeFallback = useCallback(async () => {
    try {
      console.log('๐ ุชุญููู ุงูุดุฌุฑุฉ ุงูุจุณูุทุฉ ูุญู ุงุญุชูุงุทู');
      
      // ุชุญููู ุงูุนุงุฆูุฉ ุงูุญุงููุฉ ููุท
      const familySnapshot = await getDocs(collection(db, 'users', uid, 'family'));
      const members = [];
      
      familySnapshot.forEach(doc => {
        const memberData = sanitizeMemberData({
          ...doc.data(),
          id: doc.id,
          globalId: `${uid}_${doc.id}`,
          familyUid: uid
        });
        
        if (memberData.firstName && memberData.firstName.trim() !== '') {
          members.push(memberData);
        }
      });
      
      if (members.length > 0) {
        const simpleTree = {
          nodes: members,
          links: [],
          rootId: members.find(m => m.relation === 'ุฑุจ ุงูุนุงุฆูุฉ')?.globalId || members[0].globalId
        };
        
        setTreeData(simpleTree);
        setIsTreeLoaded(true);
        console.log('โ ุชู ุชุญููู ุงูุดุฌุฑุฉ ุงูุจุณูุทุฉ ุจูุฌุงุญ');
      }
      
    } catch (error) {
      console.error('โ ุฎุทุฃ ูู ุชุญููู ุงูุดุฌุฑุฉ ุงูุจุณูุทุฉ:', error);
      setErrorMessage('ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช');
    }
  }, [uid]);
    
    // ุฏุงูุฉ ููุจุญุซ ุนู ุฌููุน ุงูุฃูุงุฑุจ ุงูุฌุงูุจููู
    function findAllCousinsAndRelatives(ancestors) {

      const relatives = [];
      
      ancestors.forEach(ancestor => {
        // ุงูุจุญุซ ุนู ุฅุฎูุฉ ูุฐุง ุงูุฌุฏ
        const uncles = mergedFamiliesData.filter(family => {
          return family.members.some(member => 
            member.multipleRoles && 
            member.multipleRoles.some(role => 
              role.familyUid === ancestor.family.uid && 
              isChildRelation(role.relation)
            ) &&
            member.multipleRoles.some(role => 
              role.familyUid === family.uid && 
              isFamilyHeadRelation(role.relation)
            )
          ) && family.uid !== ancestor.family.uid;
        });
        
        uncles.forEach(uncle => {
          const relationName = ancestor.depth === 1 ? 'ุนู' : 
                             ancestor.depth === 2 ? 'ุนู ุงูุฃุจ' : 
                             `ุนู ุงูุฌุฏ ${ancestor.depth - 1}`;
          
          relatives.push({
            family: uncle,
            depth: ancestor.depth,
            relation: relationName,
            ancestorDepth: ancestor.depth
          });

          // ุงูุจุญุซ ุนู ุฃุทูุงู ุงูุนู (ุฃุจูุงุก ุงูุนู)
          const cousinDescendants = findAllDescendants(uncle, 5);
          cousinDescendants.forEach(cousin => {
            const cousinRelation = ancestor.depth === 1 ? 
              (cousin.depth === 1 ? 'ุงุจู ุนู' : `ุญููุฏ ุงูุนู ${cousin.depth - 1}`) :
              `ุงุจู ุนู ุงูุฌุฏ ${ancestor.depth - 1}`;
              
            relatives.push({
              family: cousin.family,
              depth: ancestor.depth + cousin.depth,
              relation: cousinRelation,
              ancestorDepth: ancestor.depth
            });
          });
        });
      });

      return relatives;
    }

    const currentUserFamily = mergedFamiliesData.find(f => f.uid === rootFamilyUid);
    
    // **ุงูุจุญุซ ุงูุดุงูู ุนู ุฌููุน ุงูุฃุฌูุงู ูุงูุฃูุงุฑุจ**

    // ุงูุนุซูุฑ ุนูู ุฌููุน ุงูุฃุฌุฏุงุฏ
    const allAncestors = findAllAncestors(currentUserFamily, 10);
    
    // ุงูุนุซูุฑ ุนูู ุฌููุน ุงูุฃูุงุฑุจ ุงูุฌุงูุจููู
    const allRelatives = findAllCousinsAndRelatives(allAncestors);
    
    // ุชุญุฏูุฏ ุงูุฌุฐุฑ ุงูุฃูุฏู (ุฃุนูู ุฌุฏ ูู ุงูุณูุณูุฉ)
    const oldestAncestor = allAncestors.length > 0 ? 
      allAncestors[allAncestors.length - 1] : 
      { family: currentUserFamily, depth: 0, relation: 'ุฃูุช' };

    // ุชุญููู ุงูุฑูุงุจุท ูุชุตููููุง - ุฅุตูุงุญ ูุญุณู
    let relationships = {
      oldestRoot: oldestAncestor.family,        // ุงูุฌุฐุฑ ุงูุฃูุฏู
      ancestors: allAncestors,                  // ุฌููุน ุงูุฃุฌุฏุงุฏ
      directParent: null,                       // ุงูุฃุจ ุงููุจุงุดุฑ  
      siblings: [],                             // ุงูุฅุฎูุฉ
      uncles: [],                               // ุงูุฃุนูุงู
      cousins: [],                              // ุฃุจูุงุก ุงูุนู
      descendants: [],                          // ุงูุฃุญูุงุฏ
      relatives: allRelatives,                  // ุฌููุน ุงูุฃูุงุฑุจ ุงูุฌุงูุจููู
      others: []                                // ุจุงูู ุงูุฃูุงุฑุจ
    };

    // **ุฎุทูุฉ 1: ุงูุจุญุซ ุนู ุงูุฃุจ ุงููุจุงุดุฑ ูุงูุฅุฎูุฉ ูู ุฎูุงู ุงููููุงุช ุงููุฏููุฌุฉ**

    // ุงูุจุญุซ ุนู ุงูุฃุจ ุงููุจุงุดุฑ (ุงูุฌูู ุงูุณุงุจู ูุจุงุดุฑุฉ)
    const directParent = allAncestors.length > 0 ? allAncestors[0] : null;
    if (directParent) {
      relationships.directParent = directParent.family;

    }
    
    // ุงูุจุญุซ ุนู ุงูุฅุฎูุฉ ูู ุนุงุฆูุฉ ุงูุฃุจ ุงููุจุงุดุฑุฉ
    if (relationships.directParent) {
      // ุงูุจุญุซ ุนู ุงูุฅุฎูุฉ ูู ุนุงุฆูุฉ ุงูุฃุจ ุงููุจุงุดุฑุฉ
      const siblingsInParentFamily = relationships.directParent.members.filter(member => 
        isChildRelation(member.relation) &&
        member.globalId !== currentUserFamily.head.globalId && // ููุณ ุงููุณุชุฎุฏู ุงูุญุงูู
        member.id !== currentUserFamily.head.id
      );

      // ุฅุถุงูุฉ ูู ุฃุฎ ูุนุงุฆูุฉ ูููุตูุฉ ููุดุฌุฑุฉ
      siblingsInParentFamily.forEach(sibling => {

        // ุงูุจุญุซ ุนู ุนุงุฆูุฉ ูุฐุง ุงูุฃุฎ (ุฅุฐุง ูุงู ูู ุนุงุฆูุฉ ูููุตูุฉ)
        const siblingFamily = mergedFamiliesData.find(family => 
          family.head.globalId === sibling.globalId || 
          family.head.id === sibling.id
        );
        
        if (siblingFamily && siblingFamily.uid !== rootFamilyUid) {

          relationships.siblings.push(siblingFamily);
        }
      });
    }
    
    // **ุฎุทูุฉ 2: ุชุตููู ุงูุฃูุงุฑุจ ุงูุฌุงูุจููู**

    // ุชุตููู ุงูุฃุนูุงู ูุฃุจูุงุก ุงูุนู
    allRelatives.forEach(relative => {
      if (relative.relation.includes('ุนู') && !relative.relation.includes('ุงุจู')) {
        relationships.uncles.push(relative.family);

      } else if (relative.relation.includes('ุงุจู ุนู') || relative.relation.includes('ุญููุฏ ุงูุนู')) {
        relationships.cousins.push(relative.family);

      } else {
        relationships.others.push({family: relative.family, type: relative.relation});

      }
    });
    
    // **ุฎุทูุฉ 3: ุงูุจุญุซ ุนู ุฌููุน ุงูุฃุญูุงุฏ**

    relationships.descendants = findAllDescendants(currentUserFamily, 10);

    // **ุฎุทูุฉ 4: ูุนุงูุฌุฉ ุงูุฑูุงุจุท ุงูุชูููุฏูุฉ ุฅุฐุง ูู ูุฌุฏ ูุง ูููู ูู ุงููููุงุช ุงููุฏููุฌุฉ**
    if ((!relationships.directParent || relationships.siblings.length === 0) && currentUserFamily?.userData?.linkedFamilies) {

      currentUserFamily.userData.linkedFamilies.forEach(link => {
        const linkedFamily = mergedFamiliesData.find(f => f.uid === link.targetFamilyUid);
        
        if (linkedFamily?.head) {

          switch (link.linkType) {
            case 'father':
              if (!relationships.directParent) {
                relationships.directParent = linkedFamily;
              }
              break;
              
            case 'brother':
              if (!relationships.siblings.some(s => s.uid === linkedFamily.uid)) {
                relationships.siblings.push(linkedFamily);
              }
              break;
              
            case 'uncle':
            case 'nephew':
              if (!relationships.uncles.some(u => u.uid === linkedFamily.uid)) {
                relationships.uncles.push(linkedFamily);
              }
              break;
              
            case 'grandfather':
            case 'grandson':
              if (!relationships.others.some(o => o.family.uid === linkedFamily.uid)) {
                relationships.others.push({family: linkedFamily, type: 'grandparent'});
              }
              break;
              
            default:
              relationships.others.push({family: linkedFamily, type: link.linkType});
          }
        }
      });
    }

    // **ุฎุทูุฉ ุฅุถุงููุฉ: ุงูุงูุชุดุงู ุงูุชููุงุฆู ููุฃุนูุงู**
    // ุงูููุทู: "ุฅุฐุง ูุงู ูุฃุจู ุฃุฎ โ ูุธูุฑ ูุนู ุชููุงุฆูุงู"
    console.warn('๐ ุงูุจุญุซ ุงูุชููุงุฆู ุนู ุงูุฃุนูุงู...', {
      hasDirectParent: !!relationships.directParent,
      currentUnclesCount: relationships.uncles.length,
      allFamiliesCount: mergedFamiliesData.length
    });
    
    if (relationships.directParent) {
      const parentName = relationships.directParent.head.firstName;
      const parentGlobalId = relationships.directParent.head.globalId;
      
      console.warn('๐จ ุงูุจุญุซ ุนู ุฅุฎูุฉ ุงูุฃุจ:', parentName);
      
      // ุงูุจุญุซ ุงูุชููุงุฆู ุนู ุฅุฎูุฉ ุงูุฃุจ ูู ุฌููุน ุงูุนุงุฆูุงุช
      mergedFamiliesData.forEach(family => {
        if (family.uid !== currentUserFamily.uid && family.uid !== relationships.directParent.uid) {
          const familyHead = family.head;
          
          // ุงูุชุญูู ูู ุงูุฑูุงุจุท ุงููุฏููุฌุฉ ุฃููุงู
          if (familyHead.multipleRoles) {
            const hasBrotherRelationWithParent = familyHead.multipleRoles.some(role => 
              role.relation === 'ุฃุฎ' && role.parentName === parentName
            );
            
            if (hasBrotherRelationWithParent) {
              console.warn('โ ูุฌุฏุช ุนู ุชููุงุฆูุงู ุนุจุฑ ุงููููุงุช ุงููุฏููุฌุฉ:', familyHead.firstName, 'ุฃุฎ ูู', parentName);
              if (!relationships.uncles.some(u => u.uid === family.uid)) {
                relationships.uncles.push(family);
              }
            }
          }
          
          // ุงูุจุญุซ ูู ุงูุฑูุงุจุท ุงููุฏููุฉ ููุฐู ุงูุนุงุฆูุฉ
          if (family.userData?.linkedFamilies) {
            const hasBrotherLinkWithParent = family.userData.linkedFamilies.some(link => 
              link.targetFamilyUid === relationships.directParent.uid && link.linkType === 'brother'
            );
            
            if (hasBrotherLinkWithParent) {
              console.warn('โ ูุฌุฏุช ุนู ุชููุงุฆูุงู ุนุจุฑ ุงูุฑูุงุจุท ุงููุฏููุฉ:', familyHead.firstName, 'ูุฑุชุจุท ูุฃุฎ ูุน', parentName);
              if (!relationships.uncles.some(u => u.uid === family.uid)) {
                relationships.uncles.push(family);
              }
            }
          }
          
          // ุงูุจุญุซ ูู ุฃูุฑุงุฏ ุงูุนุงุฆูุฉ ุนู ูู ูุทุงุจู ุงูุฃุจ ูุฃุฎ
          const foundBrotherOfParent = family.members.find(member => 
            member.relation === 'ุฃุฎ' && 
            (member.linkedWith === parentGlobalId || 
             member.linkedWith === parentName ||
             member.fatherName === relationships.directParent.head.fatherName)
          );
          
          if (foundBrotherOfParent) {
            console.warn('โ ูุฌุฏุช ุนู ุชููุงุฆูุงู ุนุจุฑ ุฃูุฑุงุฏ ุงูุนุงุฆูุฉ:', familyHead.firstName, 'ุฃุฎ ูู', parentName);
            if (!relationships.uncles.some(u => u.uid === family.uid)) {
              relationships.uncles.push(family);
            }
          }
          
          // ุงูุจุญุซ ุจูุงุก ุนูู ุงุณู ุงูุฃุจ ุงููุดุชุฑู (ููุณ ุงูุฌุฏ)
          if (relationships.directParent.head.fatherName && familyHead.fatherName) {
            if (relationships.directParent.head.fatherName === familyHead.fatherName && 
                familyHead.firstName !== relationships.directParent.head.firstName) {
              console.warn('โ ูุฌุฏุช ุนู ุชููุงุฆูุงู ุนุจุฑ ุงุณู ุงูุฃุจ ุงููุดุชุฑู:', familyHead.firstName, 'ู', parentName, 'ูููุง ููุณ ุงูุฃุจ:', familyHead.fatherName);
              if (!relationships.uncles.some(u => u.uid === family.uid)) {
                relationships.uncles.push(family);
              }
            }
          }
        }
      });
      
      // ุงูุจุญุซ ุงูุนูุณู: ุงูุจุญุซ ูู ุฑูุงุจุท ุงูุฃุจ ุนู ูู ูู ูุฑุชุจุท ูุนู ูุฃุฎ
      if (relationships.directParent.userData?.linkedFamilies) {
        relationships.directParent.userData.linkedFamilies.forEach(link => {
          if (link.linkType === 'brother') {
            const uncleFamily = mergedFamiliesData.find(f => f.uid === link.targetFamilyUid);
            if (uncleFamily && uncleFamily.uid !== currentUserFamily.uid) {
              console.warn('โ ูุฌุฏุช ุนู ุชููุงุฆูุงู ุนุจุฑ ุฑูุงุจุท ุงูุฃุจ:', uncleFamily.head.firstName, 'ูุฑุชุจุท ูุฃุฎ ูุน', parentName);
              if (!relationships.uncles.some(u => u.uid === uncleFamily.uid)) {
                relationships.uncles.push(uncleFamily);
              }
            }
          }
        });
      }
    }
    
    // **ุงูุจุญุซ ุนู ุงูุฑูุงุจุท ุงููุฏููุฉ ุงููุชุจููุฉ (ููุชูุงูู ูุน ุงููุธุงู ุงููุฏูู)**
    if (relationships.directParent) {
      mergedFamiliesData.forEach(family => {
        if (family.userData?.linkedFamilies && family.uid !== currentUserFamily.uid) {
          family.userData.linkedFamilies.forEach(link => {
            // ุฅุฐุง ูุงูุช ูุฐู ุงูุนุงุฆูุฉ ูุฑุชุจุทุฉ ูุน ุฃุจู ูุฃุฎุ ุฅุฐู ูู ุนูู
            if (link.targetFamilyUid === relationships.directParent.uid && link.linkType === 'brother') {
              console.warn('โ ูุฌุฏุช ุนู ุนุจุฑ ุฑุงุจุท ุฃุฎ ูุน ุงูุฃุจ:', family.head.firstName);
              if (!relationships.uncles.some(u => u.uid === family.uid)) {
                relationships.uncles.push(family);
              }
            }
            // ุฃู ุฅุฐุง ูุงูุช ูุฑุชุจุทุฉ ูุนู ูุนู
            else if (link.targetFamilyUid === currentUserFamily.uid && link.linkType === 'nephew') {
              console.warn('โ ูุฌุฏุช ุนู ุนุจุฑ ุฑุงุจุท ุงุจู ุฃุฎ ูุนู:', family.head.firstName);
              if (!relationships.uncles.some(u => u.uid === family.uid)) {
                relationships.uncles.push(family);
              }
            }
          });
        }
      });
    }

    // **ุงูุจุญุซ ุนู ูู ูู ูุฑุชุจุท ูุนู ูุนู ูุจุงุดุฑุฉ (ููุชูุงูู ูุน ุงููุธุงู ุงููุฏูู)**
    mergedFamiliesData.forEach(family => {
      if (family.userData?.linkedFamilies && family.uid !== currentUserFamily.uid) {
        family.userData.linkedFamilies.forEach(link => {
          if (link.targetFamilyUid === currentUserFamily.uid && link.linkType === 'nephew') {
            console.warn('โ ูุฌุฏุช ุนู ูุฑุชุจุท ูุนู ูุจุงุดุฑุฉ:', family.head.firstName);
            if (!relationships.uncles.some(u => u.uid === family.uid)) {
              relationships.uncles.push(family);
            }
          }
        });
      }
    });
    
    console.warn('๐ ูุชุงุฆุฌ ุงูุงูุชุดุงู ุงูุชููุงุฆู ููุฃุนูุงู:', {
      unclesFound: relationships.uncles.length,
      uncleNames: relationships.uncles.map(u => u.head.firstName),
      detectionMethod: 'ุชููุงุฆู + ุฑูุงุจุท ูุฏููุฉ'
    });

    console.warn('๐๏ธ ุญุงูุฉ ุงูุนูุงูุงุช ูุจู ุจูุงุก ุงูุดุฌุฑุฉ:', {
      hasDirectParent: !!relationships.directParent,
      parentName: relationships.directParent?.head?.firstName,
      unclesCount: relationships.uncles.length,
      siblingsCount: relationships.siblings.length,
      scenarioWillUse: relationships.directParent ? 'ุฃุจ ููุท' : 
                      relationships.uncles.length > 0 ? 'ุนู ููุท' : 'ุดุฌุฑุฉ ุจุณูุทุฉ'
    });

    // ุฎุฑูุทุฉ ููุนูุฏ ุงูููุดุฃุฉ ูุชุฌูุจ ุงูุชูุฑุงุฑ
    const createdNodes = new Map();
    
    // ุฏุงูุฉ ูุณุงุนุฏุฉ ูุชุญุฏูุฏ ุงุณู ุงูุฌูู/ุงูุนูุงูุฉ ุจูุงุกู ุนูู ุงูุนูู ูุงูููุน
    function getGenerationName(depth, type = 'descendant') {
      if (type === 'ancestor') {
        // ุชุณููุฉ ุงูุฃุฌุฏุงุฏ
        switch(depth) {
          case 1:
            return 'ุฃุจ';
          case 2:
            return 'ุฌุฏ';
          case 3:
            return 'ุฌุฏ ุงูุฌุฏ';
          case 4:
            return 'ุฌุฏ ุงูุฌูู ุงูุฑุงุจุน';
          case 5:
            return 'ุฌุฏ ุงูุฌูู ุงูุฎุงูุณ';
          case 6:
            return 'ุฌุฏ ุงูุฌูู ุงูุณุงุฏุณ';
          case 7:
            return 'ุฌุฏ ุงูุฌูู ุงูุณุงุจุน';
          case 8:
            return 'ุฌุฏ ุงูุฌูู ุงูุซุงูู';
          case 9:
            return 'ุฌุฏ ุงูุฌูู ุงูุชุงุณุน';
          case 10:
            return 'ุฌุฏ ุงูุฌูู ุงูุนุงุดุฑ';
          case 11:
            return 'ุฌุฏ ุงูุฌูู ุงูุญุงุฏู ุนุดุฑ';
          case 12:
            return 'ุฌุฏ ุงูุฌูู ุงูุซุงูู ุนุดุฑ';
          case 13:
            return 'ุฌุฏ ุงูุฌูู ุงูุซุงูุซ ุนุดุฑ';
          case 14:
            return 'ุฌุฏ ุงูุฌูู ุงูุฑุงุจุน ุนุดุฑ';
          case 15:
            return 'ุฌุฏ ุงูุฌูู ุงูุฎุงูุณ ุนุดุฑ';
          default:
            if (depth < 20) {
              return `ุฌุฏ ุงูุฌูู ${depth}`;
            } else {
              return `ูู ุฃุฌุฏุงุฏ ุงูุฌูู ${depth}`;
            }
        }
      } else {
        // ุชุณููุฉ ุงูุฃุญูุงุฏ/ุงูุฃุจูุงุก
        switch(depth) {
          case 0:
            return 'ุงุจู';
          case 1:
            return 'ุญููุฏ';
          case 2:
            return 'ุญููุฏ ุงูุญููุฏ';
          case 3:
            return 'ุงุจู ุงูุฌูู ุงูุฑุงุจุน';
          case 4:
            return 'ุงุจู ุงูุฌูู ุงูุฎุงูุณ';
          case 5:
            return 'ุงุจู ุงูุฌูู ุงูุณุงุฏุณ';
          case 6:
            return 'ุงุจู ุงูุฌูู ุงูุณุงุจุน';
          case 7:
            return 'ุงุจู ุงูุฌูู ุงูุซุงูู';
          case 8:
            return 'ุงุจู ุงูุฌูู ุงูุชุงุณุน';
          case 9:
            return 'ุงุจู ุงูุฌูู ุงูุนุงุดุฑ';
          case 10:
            return 'ุงุจู ุงูุฌูู ุงูุญุงุฏู ุนุดุฑ';
          case 11:
            return 'ุงุจู ุงูุฌูู ุงูุซุงูู ุนุดุฑ';
          case 12:
            return 'ุงุจู ุงูุฌูู ุงูุซุงูุซ ุนุดุฑ';
          case 13:
            return 'ุงุจู ุงูุฌูู ุงูุฑุงุจุน ุนุดุฑ';
          case 14:
            return 'ุงุจู ุงูุฌูู ุงูุฎุงูุณ ุนุดุฑ';
          default:
            if (depth < 20) {
              return `ุงุจู ุงูุฌูู ${depth + 1}`;
            } else {
              return `ูู ุฐุฑูุฉ ุงูุฌูู ${depth + 1}`;
            }
        }
      }
    }

    // ุฏุงูุฉ ูุณุงุนุฏุฉ ููุชุญูู ูู ุงูุนูุงูุงุช ุงูุดุงุฆุนุฉ
    function isChildRelation(relation) {
      return relation === 'ุงุจู' || relation === 'ุจูุช';
    }

    function isFamilyHeadRelation(relation) {
      return relation === 'ุฑุจ ุงูุนุงุฆูุฉ';
    }
    
    // ุฏุงูุฉ ูุณุงุนุฏุฉ ูุฅูุดุงุก ุนูุฏุฉ ุดุฎุต ุจุฏูู ุฅุถุงูุฉ ุงูุฃุทูุงู ุชููุงุฆูุงู
    function createPersonNodeWithoutChildren(familyData, familyLabel, relationLabel, isCurrentUser = false) {
      const person = familyData.head;
      // ุฅูุดุงุก ูุนุฑู ูุฑูุฏ ูุนุชูุฏ ุนูู ุงูุดุฎุต ูุงูุฏูุฑ ูุชุฌูุจ ุชุถุงุฑุจ ุงููููุงุช ุงููุฏููุฌุฉ
      const personKey = `${person.globalId || person.id}_${relationLabel}_${familyData.uid}`;
      
      // ุงูุชุญูู ูู ูุฌูุฏ ุงูุนูุฏุฉ ูุณุจูุงู ูุชุฌูุจ ุงูุชูุฑุงุฑ
      if (createdNodes.has(personKey)) {
        const existingNode = createdNodes.get(personKey);
        
        // ุชุญุฏูุซ ุงูุนูุงูุฉ ุฅุฐุง ูุงูุช ุฃูุซุฑ ุฃูููุฉ
        const currentRelationPriority = getRelationPriority(relationLabel);
        const existingRelationPriority = getRelationPriority(existingNode.attributes.actualRelation);
        
        if (currentRelationPriority > existingRelationPriority) {
          existingNode.attributes.actualRelation = relationLabel;
          existingNode.attributes.familyName = familyLabel;
          
          // ุชุญุฏูุซ ุญุงูุฉ ุงููุณุชุฎุฏู ุงูุญุงูู ุฅุฐุง ูุฒู ุงูุฃูุฑ
          if (isCurrentUser) {
            existingNode.attributes.isCurrentUser = true;
          }
        }
        
        // ุฅุถุงูุฉ ุงูุฏูุฑ ุงูุฌุฏูุฏ ุฅูู ุงููุงุฆูุฉ (ุชุฌูุจ ุงูุชูุฑุงุฑ)
        if (person.multipleRoles) {
          const existingRoleIds = new Set(existingNode.attributes.allRoles.map(r => `${r.familyUid}_${r.relation}`));
          const newRoles = person.multipleRoles.filter(role => 
            !existingRoleIds.has(`${role.familyUid}_${role.relation}`)
          );
          
          existingNode.attributes.allRoles = [
            ...existingNode.attributes.allRoles,
            ...newRoles
          ];
          existingNode.attributes.hasMultipleRoles = existingNode.attributes.allRoles.length > 1;
        }

        return existingNode;
      }
      
      // ุชุญุฏูุฏ ุงูุงุณู ูุงูุฏูุฑ ุงูููุงุณุจ
      const displayName = buildFullName(person);
      
      // ุชุญุฏูุฏ ุงูุนูุงูุฉ ุงูุฃุณุงุณูุฉ (ุฃููููุฉ ููุฃุจ > ุฑุจ ุงูุนุงุฆูุฉ > ุงุจู)
      let primaryRelation = relationLabel;
      if (person.multipleRoles) {
        const relationPriorities = person.multipleRoles.map(r => ({
          relation: r.relation,
          priority: getRelationPriority(r.relation)
        }));
        
        const highestPriorityRole = relationPriorities.reduce((prev, current) => 
          current.priority > prev.priority ? current : prev
        );
        
        primaryRelation = highestPriorityRole.relation;
      }
      
      const node = {
        name: displayName,
        id: personKey,
        avatar: person.avatar || null,
        attributes: {
          ...person,
          isCurrentUser,
          treeType: 'extended',
          isExtended: !isCurrentUser,
          familyName: familyLabel,
          actualRelation: primaryRelation,
          // ุฅุถุงูุฉ ูุนูููุงุช ุงูุฃุฏูุงุฑ ุงููุชุนุฏุฏุฉ
          hasMultipleRoles: !!person.multipleRoles,
          allRoles: person.multipleRoles || [{ familyUid: familyData.uid, relation: relationLabel }]
        },
        children: []
      };

      // ุญูุธ ุงูุนูุฏุฉ ูู ุงูุฎุฑูุทุฉ
      createdNodes.set(personKey, node);

      return node;
    }
    
    // ุฏุงูุฉ ูุฅุถุงูุฉ ุงูุฃุทูุงู ููุท ูู ุนุงุฆูุฉ ุงูุดุฎุต ููุณู
    function addChildrenToNode(node, familyData) {
      const person = familyData.head;
      const children = familyData.members.filter(m => 
        (m.relation === 'ุงุจู' || m.relation === 'ุจูุช') && 
        (m.globalId !== person.globalId && m.id !== person.id)
      );

      children.forEach(child => {
        const childKey = child.globalId || child.id;
        
        // ุชุฌูุจ ุฅุถุงูุฉ ุงูุทูู ุฅุฐุง ูุงู ููุฌูุฏ ุจุงููุนู ูู ุฃู ููุงู ูู ุงูุดุฌุฑุฉ
        if (!createdNodes.has(childKey)) {
          // ุชุญูู ุฅุฐุง ูุงู ูุฐุง ุงูุทูู ูู ุนุงุฆูุฉ ูููุตูุฉ (ูุจุงูุชุงูู ุณูุธูุฑ ูู ูุณุชูู ูููุตู)
          const hasOwnFamily = mergedFamiliesData.some(family => 
            (family.head.globalId === child.globalId || family.head.id === child.id) &&
            family.uid !== familyData.uid
          );
          
          if (!hasOwnFamily) {
            // ููุท ุฅุถุงูุฉ ุงูุฃุทูุงู ุงูุฐูู ููุณ ููู ุนุงุฆูุงุช ูููุตูุฉ
            const childDisplayRelation = child.multipleRoles 
              ? getHighestPriorityRelation(child.multipleRoles)
              : child.relation;
              
            const childNode = {
              name: buildFullName(child),
              id: childKey,
              avatar: child.avatar || null,
              attributes: {
                ...child,
                isCurrentUser: false,
                treeType: 'extended',
                isExtended: true,
                familyName: `ุฃุทูุงู ${node.attributes.familyName}`,
                actualRelation: childDisplayRelation,
                hasMultipleRoles: !!child.multipleRoles,
                allRoles: child.multipleRoles || [{ familyUid: familyData.uid, relation: child.relation }]
              },
              children: []
            };
            
            createdNodes.set(childKey, childNode);
            node.children.push(childNode);
          }
        }
      });
    }

    // ุฏุงูุฉ ูุชุญุฏูุฏ ุฃููููุฉ ุงูุนูุงูุงุช
    function getRelationPriority(relation) {
      const priorities = {
        'ุฌุฏ': 100,
        'ุฃุจ': 90,
        'ุนู': 80,
        'ุฑุจ ุงูุนุงุฆูุฉ': 70,
        'ุงุจู': 60,
        'ุจูุช': 60,
        'ุฃุฎ': 50,
        'ุฃุฎุช': 50,
        'ุงุจู ุนู': 40,
        'ูุฑูุจ': 30
      };
      return priorities[relation] || 20;
    }
    
    // ุฏุงูุฉ ููุญุตูู ุนูู ุงูุนูุงูุฉ ุฐุงุช ุงูุฃููููุฉ ุงูุฃุนูู
    function getHighestPriorityRelation(roles) {
      return roles.reduce((prev, current) => 
        getRelationPriority(current.relation) > getRelationPriority(prev.relation) ? current : prev
      ).relation;
    }

    // ุฏุงูุฉ ููุจุญุซ ุนู ุงููุณุชุฎุฏู ูู ุงูุดุฌุฑุฉ
    function findUserNode(node) {
      if (node.attributes?.isCurrentUser) {
        return node;
      }
      for (let child of node.children) {
        const found = findUserNode(child);
        if (found) return found;
      }
      return null;
    }
    
    // ุฏุงูุฉ ููุจุญุซ ุนู ูุงูุฏ ุนูุฏุฉ ูุนููุฉ
    function findParentOfNode(rootNode, targetNode) {
      for (let child of rootNode.children) {
        if (child.id === targetNode.id) {
          return rootNode;
        }
        const found = findParentOfNode(child, targetNode);
        if (found) return found;
      }
      return null;
    }

    // **ุงุฎุชูุงุฑ ุงูุณููุงุฑูู ุงูููุงุณุจ ุจุงูุฃููููุฉ ุงูุตุญูุญุฉ**
    
    // **ุงูุณููุงุฑูู ุงูุดุงูู: ุฅุฐุง ููุฌุฏ ุฌุฐุฑ ุฃูุฏูุ ุงุจูู ุงูุดุฌุฑุฉ ูู ุงูุฃุนูู**
    if (relationships.ancestors.length > 0) {
      console.warn('๐ ุฏุฎูู ุงูุณููุงุฑูู ุงูุดุงูู:', {
        ancestorsCount: relationships.ancestors.length,
        hasDirectParent: !!relationships.directParent,
        unclesCount: relationships.uncles.length,
        willUseFallback: 'ูุนู - ุงูุณููุงุฑูู ุงูุดุงูู'
      });

      // ุจูุงุก ุงูุดุฌุฑุฉ ูู ุงูุฌุฐุฑ ุงูุฃูุฏู ููุฃุณูู
      function buildComprehensiveTree() {
        const rootNode = createPersonNodeWithoutChildren(
          relationships.oldestRoot, 
          buildFullName(relationships.oldestRoot.head), 
          relationships.oldestRoot.head.relation || 'ุฑุจ ุงูุนุงุฆูุฉ'
        );
        
        // ุจูุงุก ุงูุดุฌุฑุฉ ุจุดูู ุชุฏุฑูุฌู ูู ุงูุฃุนูู ููุฃุณูู - ูุญุณู ููุฃุฌูุงู ุงูุนูููุฉ
        function buildGenerationLevel(parentNode, parentFamily, currentDepth, maxDepth = 15) {
          if (currentDepth >= maxDepth) {

            return;
          }

          // ุงูุจุญุซ ุนู ุฃุทูุงู ูุฐุง ุงููุณุชูู (ุงูุฐูู ููู ุนุงุฆูุงุช ูููุตูุฉ)

          // ุฅุนุงุฏุฉ ุชุตููู ููุทู ุงูุจุญุซ - ุงูุจุญุซ ูุจุงุดุฑุฉ ุนู ุงูุนุงุฆูุงุช ุงูุชู ูููู ูููุง ุดุฎุต ุฑุจ ุนุงุฆูุฉ ูุงุจู ุงููุงูุฏ
          const childrenAtThisLevel = [];

          // ุงูุจุญุซ ูู ุนุงุฆูุฉ ุงููุงูุฏ ุนู ุงูุฃุทูุงู ุงูุฐูู ููู ุนุงุฆูุงุช ูููุตูุฉ
          parentFamily.members.forEach(member => {

            if (member.multipleRoles && isChildRelation(member.relation)) {

              // ุงูุจุญุซ ุนู ุงูุนุงุฆูุฉ ุงูุชู ูููู ูููุง ุฑุจ ุนุงุฆูุฉ
              const separateFamily = mergedFamiliesData.find(family => {
                return member.multipleRoles.some(role => 
                  role.familyUid === family.uid && isFamilyHeadRelation(role.relation)
                );
              });
              
              if (separateFamily && separateFamily.uid !== parentFamily.uid) {

                // ุงูุชุฃูุฏ ูู ุนุฏู ุงูุฅุถุงูุฉ ุงูููุฑุฑุฉ
                if (!childrenAtThisLevel.some(child => child.uid === separateFamily.uid)) {
                  childrenAtThisLevel.push(separateFamily);
                }
              }
            }
          });

          childrenAtThisLevel.forEach((childFamily) => {

            if (childFamily.uid !== parentFamily.uid) {

              // ุงุณุชุฎุฏุงู ุงูุฏุงูุฉ ุงููุดุชุฑูุฉ ูุชุณููุฉ ุงูุฃุฌูุงู
              const relationName = getGenerationName(currentDepth, 'descendant');
              
              // ุชุญุฏูุฏ ุงูุชุณููุฉ ุงููุนุฑูุถุฉ
              let displayLabel;
              if (currentDepth <= 2) {
                displayLabel = relationName;
              } else if (currentDepth < 20) {
                displayLabel = `ุงูุฌูู ${currentDepth + 1}`;
              } else {
                displayLabel = `ูุณู ุงูุฌูู ${currentDepth + 1}`;
              }
              
              const isCurrentUser = childFamily.uid === rootFamilyUid;
              if (isCurrentUser) {
                displayLabel = 'ุฃูุช';
              }

              const childNode = createPersonNodeWithoutChildren(
                childFamily,
                displayLabel,
                relationName,
                isCurrentUser
              );
              
              // ุฅุถุงูุฉ ูุนูููุงุช ุงูุนูู ููุนูุฏุฉ
              childNode.attributes.generationDepth = currentDepth + 1;
              childNode.attributes.generationLevel = `ุงูุฌูู ${currentDepth + 1}`;

              parentNode.children.push(childNode);

              // ุฅุถุงูุฉ ุงูุฃุทูุงู ุงููุนูููู ูู ุนุงุฆูุฉ ูุฐุง ุงูุดุฎุต
              addChildrenToNode(childNode, childFamily);
              
              // ุชุชุจุน ุงูุนูู ุงูุญูููู ููุดุฌุฑุฉ
              const currentActualDepth = currentDepth + 1;
              if (currentActualDepth > (window.familyTreeMetrics?.maxDepthReached || 0)) {
                window.familyTreeMetrics = window.familyTreeMetrics || {};
                window.familyTreeMetrics.maxDepthReached = currentActualDepth;
              }
              
              // ุงูุงุณุชูุฑุงุฑ ูู ุงูุจูุงุก ูููุณุชูู ุงูุชุงูู ูุน ุญูุงูุฉ ูู ุงูุชูุฑุงุฑ ุงููุงููุงุฆู
              buildGenerationLevel(childNode, childFamily, currentDepth + 1, maxDepth);
            }
          });
        }

        // ุฅุถุงูุฉ ุฃุทูุงู ุงูุฌุฐุฑ ุงููุนูููู ุฃููุงู (ุงูุฐูู ููุณ ููู ุนุงุฆูุงุช ูููุตูุฉ)
        addChildrenToNode(rootNode, relationships.oldestRoot);
        
        // ุซู ุจูุงุก ุงููุณุชูู ุงูุฃูู (ุงูุฃุทูุงู ุจุนุงุฆูุงุช ูููุตูุฉ)
        buildGenerationLevel(rootNode, relationships.oldestRoot, 0);

        // **ุฅุถุงูุฉ ุฎุงุตุฉ: ุฏูุฌ ุงูุฃุนูุงู ุงูููุถุงููู ุนุจุฑ ุงูุฑูุงุจุท ุงูุชูููุฏูุฉ**
        if (relationships.uncles.length > 0) {
          console.warn('๐ง ุฅุถุงูุฉ ุงูุฃุนูุงู ููุณููุงุฑูู ุงูุดุงูู:', {
            unclesCount: relationships.uncles.length,
            uncleNames: relationships.uncles.map(u => u.head.firstName)
          });

          // ุงูุจุญุซ ุนู ุงููุณุชูู ุงูููุงุณุจ ูุฅุถุงูุฉ ุงูุฃุนูุงู (ููุณ ูุณุชูู ุงูุฃุจ)
          let grandparentLevel = null;
          let parentNode = null;
          
          const userNode = findUserNode(rootNode);
          if (userNode) {
            // ุงูุจุญุซ ุนู ูุงูุฏ ุงููุณุชุฎุฏู (ุงูุฃุจ)
            const userParent = findParentOfNode(rootNode, userNode);
            if (userParent) {
              parentNode = userParent;
              console.warn('๐ ุชู ุงูุนุซูุฑ ุนูู ุงูุฃุจ:', {
                parentName: userParent.name,
                parentId: userParent.id
              });
              
              // ุงูุจุญุซ ุนู ูุงูุฏ ุงูุฃุจ (ุงูุฌุฏ) - ููุง ุณูุถุน ุงูุฃุนูุงู
              const grandparent = findParentOfNode(rootNode, userParent);
              if (grandparent) {
                grandparentLevel = grandparent;
                console.warn('โ ุชู ุงูุนุซูุฑ ุนูู ูุณุชูู ุงูุฌุฏ ูุฅุถุงูุฉ ุงูุฃุนูุงู:', {
                  grandparentName: grandparent.name,
                  currentChildrenCount: grandparent.children.length
                });
              } else {
                console.warn('โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุฌุฏุ ุณูุชู ุฅุถุงูุฉ ุงูุฃุนูุงู ูุฅุฎูุฉ ููุฃุจ ูู ููุณ ูุณุชูู ุงูุฃุจ');
                // ุงูุจุญุซ ุนู ุงููุณุชูู ุงูุฐู ูุญุชูู ุนูู ุงูุฃุจ
                grandparentLevel = findParentOfNode(rootNode, userParent);
                if (!grandparentLevel) {
                  // ุฅุฐุง ูุงู ุงูุฃุจ ูู ุงููุณุชูู ุงูุฃุนููุ ุงุณุชุฎุฏู ุงูุฌุฐุฑ
                  grandparentLevel = rootNode;
                  console.warn('๐ง ุณูุชู ุฅุถุงูุฉ ุงูุฃุนูุงู ูู ุงููุณุชูู ุงูุฌุฐุฑ');
                }
              }
            }
          }
          
          // ุฅุถุงูุฉ ุงูุฃุนูุงู ูุฅุฎูุฉ ููุฃุจ ูู ููุณ ุงููุณุชูู
          if (grandparentLevel && parentNode) {
            relationships.uncles.forEach((uncle, index) => {
              const uncleKey = `${uncle.head.globalId || uncle.head.id}_ุนู_${uncle.uid}`;
              
              // ุชุฃูุฏ ูู ุนุฏู ูุฌูุฏ ุงูุนู ูุณุจูุงู
              if (!createdNodes.has(uncleKey)) {
                const uncleNode = createPersonNodeWithoutChildren(uncle, `ุงูุนู ${index + 1}`, 'ุนู');
                
                // ุฅุถุงูุฉ ุงูุนู ูู ููุณ ุงููุณุชูู ูุน ุงูุฃุจ
                grandparentLevel.children.push(uncleNode);
                addChildrenToNode(uncleNode, uncle);
                
                console.warn(`โ ุชูุช ุฅุถุงูุฉ ุงูุนู ููุดุฌุฑุฉ ุงูุดุงููุฉ:`, {
                  uncleName: uncle.head.firstName,
                  uncleId: uncleNode.id,
                  addedToLevel: grandparentLevel.name,
                  nowSiblingToParent: parentNode.name,
                  parentLevel: grandparentLevel.children.length
                });
              }
            });
          } else {
            console.warn('โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ูุณุชูู ููุงุณุจ ูุฅุถุงูุฉ ุงูุฃุนูุงู:', {
              hasGrandparentLevel: !!grandparentLevel,
              hasParentNode: !!parentNode,
              hasUserNode: !!userNode
            });
          }
        }

        // ุฅุญุตุงุฆูุงุช ุดุงููุฉ ููุดุฌุฑุฉ ุงููุจููุฉ
        const treeStats = {
          totalNodes: createdNodes.size,
          maxDepthReached: window.familyTreeMetrics?.maxDepthReached || 0,
          generationsCovered: relationships.ancestors.length + relationships.descendants.length + 1,
          ancestorGenerations: relationships.ancestors.length,
          descendantGenerations: relationships.descendants.length,
          lateralRelatives: relationships.siblings.length + relationships.uncles.length + relationships.cousins.length
        };
        
        // ุชุญุฏูุซ ุงููุชุบูุฑุงุช ุงูุนุงูุฉ ููุชุชุจุน
        window.familyTreeMetrics = window.familyTreeMetrics || {};
        window.familyTreeMetrics.totalNodes = treeStats.totalNodes;
        window.familyTreeMetrics.actualMembersCount = treeStats.totalNodes; // ุงูุนุฏุฏ ุงููุนูู ููุนูุฏ

        // ุทุจุงุนุฉ ูุนูููุงุช ุงูุชุญุฏูุซ ุงูุนุงู

        // ุชูููู ููุงุกุฉ ุงููุธุงู
        // ุชู ุฅุฒุงูุฉ if ูุงุฑุบุฉ else if (treeStats.maxDepthReached >= 5) {

        // ุชู ุฅุฒุงูุฉ else ูุงุฑุบุฉ
        
        // ุนุฑุถ ุชูุจูู ูููุณุชุฎุฏู ุญูู ุญุงูุฉ ุงูุดุฌุฑุฉ
        // ุชู ุฅุฒุงูุฉ if ูุงุฑุบุฉ else if (treeStats.totalNodes >= 20) {

        // ุชู ุฅุฒุงูุฉ else ูุงุฑุบุฉ
        
        // ุทุจุงุนุฉ ุชูุงุตูู ุงูุฃุทูุงู
        rootNode.children.forEach((child) => {
          child.children.forEach(() => { /* ูุนุงูุฌุฉ ุงูุนูุงุตุฑ */ });
        });
        
        return rootNode;
      }
      
      return buildComprehensiveTree();
    }

    // **ุณููุงุฑูู: ููุฌุฏ ุฃุจ ููุท - ุงูุฃุจ ูู ุงูุฌุฐุฑ**
    else if (relationships.directParent) {
      
      const parentNode = createPersonNodeWithoutChildren(relationships.directParent, 'ุงูุฃุจ', 'ุฃุจ');
      
      // ุฅุถุงูุฉ ุงููุณุชุฎุฏู ุงูุญุงูู ูุงูุฅุฎูุฉ ุชุญุช ุงูุฃุจ
      const userNode = createPersonNodeWithoutChildren(currentUserFamily, 'ุฃูุช', 'ุงุจู', true);
      
      // ุงูุชุญูู ูู ุฃู ุงููุณุชุฎุฏู ููุณ ูู ููุณู ุงูุฃุจ
      if (userNode.id !== parentNode.id) {
        parentNode.children.push(userNode);
      }
      
      relationships.siblings.forEach(sibling => {
        const siblingNode = createPersonNodeWithoutChildren(sibling, 'ุฃุฎ', 'ุงุจู');
        
        // ุชุฌูุจ ุฅุถุงูุฉ ุงูุฃุฎ ุฅุฐุง ูุงู ูู ููุณู ุงูุฃุจ ุฃู ุงููุณุชุฎุฏู
        if (siblingNode.id !== parentNode.id && siblingNode.id !== userNode.id) {
          parentNode.children.push(siblingNode);
        }
      });

      // ุฅุถุงูุฉ ุงูุฃุนูุงู ูุฅุฎูุฉ ููุฃุจ ูู ููุณ ุงููุณุชูู
      relationships.uncles.forEach((uncle, index) => {
        const uncleNode = createPersonNodeWithoutChildren(uncle, `ุงูุนู ${index + 1}`, 'ุนู');
        
        // ุชุฌูุจ ุฅุถุงูุฉ ุงูุนู ุฅุฐุง ูุงู ูู ููุณู ุงูุฃุจ
        if (uncleNode.id !== parentNode.id) {
          // ุณูุถุน ุงูุฃุนูุงู ุจุฌุงูุจ ุงูุฃุจ ุจุฏูุงู ูู ุชุญุชู
          // ููู ูุฐุง ูุชุทูุจ ุฅูุดุงุก ูุณุชูู ุฃุนููุ ูุฐุง ุณูุชุฌุงูู ุงูุฃุนูุงู ูู ูุฐุง ุงูุณููุงุฑูู
          addChildrenToNode(uncleNode, uncle);
        }
      });
      
      // ุฅุถุงูุฉ ุฃุทูุงู ูู ุนูุฏุฉ ูู ุนุงุฆูุชูุง ุงููููุตูุฉ
      addChildrenToNode(parentNode, relationships.directParent);
      
      if (userNode.id !== parentNode.id) {
        addChildrenToNode(userNode, currentUserFamily);
      }
      
      relationships.siblings.forEach((sibling) => {
        const siblingNode = parentNode.children.find(child => 
          child.id.includes(sibling.head.globalId || sibling.head.id)
        );
        if (siblingNode) {
          addChildrenToNode(siblingNode, sibling);
        }
      });

      return parentNode;
    }

    // **ุงูุณููุงุฑูู ุงูุดุงูู: ููุท ุฅุฐุง ูู ููู ููุงู ุฃุจ ูุนู**
    // ุฅุฐุง ููุฌุฏ ุฌุฐุฑ ุฃูุฏูุ ุงุจูู ุงูุดุฌุฑุฉ ูู ุงูุฃุนูู
    // (ุชูุช ุฅุฒุงูุฉ ุงููุฑุน ุงูููุฑุฑ ููุนูุงูุฉ ancestors.length > 0 ูุฃูู ูุบุทู ุจุงููุนู ุฃุนูุงู)

    // **ุณููุงุฑูู: ููุฌุฏ ุนู ููุท - ุงูุนู ูู ุงูุฌุฐุฑ**
    else if (relationships.uncles.length > 0) {
      
      // ุงุณุชุฎุฏุงู ุงูุนู ุงูุฃูู ูุฌุฐุฑ
      const uncleNode = createPersonNodeWithoutChildren(relationships.uncles[0], 'ุงูุนู', 'ุนู');
      
      // ุฅุถุงูุฉ ุงููุณุชุฎุฏู ุงูุญุงูู ูุงูุฅุฎูุฉ ูุฃุจูุงุก ุฃุฎ
      const userNode = createPersonNodeWithoutChildren(currentUserFamily, 'ุฃูุช', 'ุงุจู ุฃุฎ', true);
      
      // ุงูุชุญูู ูู ุฃู ุงููุณุชุฎุฏู ููุณ ูู ููุณู ุงูุนู
      if (userNode.id !== uncleNode.id) {
        uncleNode.children.push(userNode);
      }
      
      relationships.siblings.forEach(sibling => {
        const siblingNode = createPersonNodeWithoutChildren(sibling, 'ุฃุฎ', 'ุงุจู ุฃุฎ');
        
        // ุชุฌูุจ ุฅุถุงูุฉ ุงูุฃุฎ ุฅุฐุง ูุงู ูู ููุณู ุงูุนู ุฃู ุงููุณุชุฎุฏู
        if (siblingNode.id !== uncleNode.id && siblingNode.id !== userNode.id) {
          uncleNode.children.push(siblingNode);
        }
      });

      // ุฅุถุงูุฉ ุงูุฃุนูุงู ุงูุฅุถุงูููู ูุฅุฎูุฉ ููุนู ุงูุฃูู
      relationships.uncles.slice(1).forEach((uncle, index) => {
        const additionalUncleNode = createPersonNodeWithoutChildren(uncle, `ุงูุนู ${index + 2}`, 'ุนู');
        // ูููู ุฅุถุงูุชูู ูุฃุทูุงู ููุนู ุงูุฃูู ุฃู ุชุฌุงูููู
        addChildrenToNode(additionalUncleNode, uncle);
      });

      // ุฅุถุงูุฉ ุฃุทูุงู ูู ุนูุฏุฉ ูู ุนุงุฆูุชูุง ุงููููุตูุฉ
      addChildrenToNode(uncleNode, relationships.uncles[0]);
      
      if (userNode.id !== uncleNode.id) {
        addChildrenToNode(userNode, currentUserFamily);
      }
      
      relationships.siblings.forEach((sibling) => {
        const siblingNode = uncleNode.children.find(child => 
          child.id.includes(sibling.head.globalId || sibling.head.id)
        );
        if (siblingNode) {
          addChildrenToNode(siblingNode, sibling);
        }
      });

      return uncleNode;
    }

    // **ุณููุงุฑูู: ูุง ููุฌุฏ ุฃุจ ุฃู ุนู - ุงููุณุชุฎุฏู ูู ุงูุฌุฐุฑ**
    else {
      // ุฅุฐุง ูุงู ูุฏูู ุฅุฎูุฉ ุฃู ุฃูุงุฑุจ ุขุฎุฑููุ ุถุนูู ูุฅุฎูุฉ ูู ููุณ ุงููุณุชูู
      if (relationships.siblings.length > 0 || relationships.cousins.length > 0 || relationships.others.length > 0) {

        // ุฅูุดุงุก ุนูุฏุฉ ุงููุณุชุฎุฏู ุงูุญุงูู ูุฌุฐุฑ
        const userNode = createPersonNodeWithoutChildren(currentUserFamily, 'ุฃูุช', 'ุฑุจ ุนุงุฆูุฉ', true);

        // ุฅุถุงูุฉ ุงูุฅุฎูุฉ ูุฃุทูุงู ูููุณุชุฎุฏู (ุฃู ูููู ุชุนุฏูู ูุฐุง ููููููุง ูู ููุณ ุงููุณุชูู)
        relationships.siblings.forEach(sibling => {
          const siblingNode = createPersonNodeWithoutChildren(sibling, 'ุฃุฎ', 'ุฃุฎ');
          
          // ุชุฌูุจ ุฅุถุงูุฉ ุงูุฃุฎ ุฅุฐุง ูุงู ูู ููุณู ุงููุณุชุฎุฏู
          if (siblingNode.id !== userNode.id) {
            userNode.children.push(siblingNode);
            addChildrenToNode(siblingNode, sibling);
          }
        });

        // ุฅุถุงูุฉ ุฃุจูุงุก ุงูุนู ูุฃุทูุงู ุฃูุถุงู
        relationships.cousins.forEach(cousin => {
          const cousinNode = createPersonNodeWithoutChildren(cousin, 'ุงุจู ุนู', 'ุงุจู ุนู');
          
          // ุชุฌูุจ ุงูุชูุฑุงุฑ
          if (!userNode.children.some(child => child.id === cousinNode.id)) {
            userNode.children.push(cousinNode);
            addChildrenToNode(cousinNode, cousin);
          }
        });

        // ุฅุถุงูุฉ ุงูุฃูุงุฑุจ ุงูุขุฎุฑูู
        relationships.others.forEach(otherRel => {
          const otherNode = createPersonNodeWithoutChildren(otherRel.family, 'ูุฑูุจ', 'ูุฑูุจ');
          
          // ุชุฌูุจ ุงูุชูุฑุงุฑ
          if (!userNode.children.some(child => child.id === otherNode.id)) {
            userNode.children.push(otherNode);
            addChildrenToNode(otherNode, otherRel.family);
          }
        });

        // ุฅุถุงูุฉ ุฃุทูุงู ุงููุณุชุฎุฏู ูู ุนุงุฆูุชู
        addChildrenToNode(userNode, currentUserFamily);

        return userNode;
      } else {
        // ูุง ุชูุฌุฏ ุฃูุงุฑุจ ุขุฎุฑูู - ุฃุฑุฌุน ุงููุณุชุฎุฏู ุงูุญุงูู ูุฌุฐุฑ ูุจุงุดุฑ
        const userNode = createPersonNodeWithoutChildren(currentUserFamily, 'ุฃูุช', 'ุฑุจ ุงูุนุงุฆูุฉ', true);
        addChildrenToNode(userNode, currentUserFamily);
        return userNode;
      }
    }
  }, []); // ุฅุบูุงู ุตุญูุญ ููุฏุงูุฉ

  // ===========================================================================
  // ุฏูุงู ุงูุชุญููู ุงูุฑุฆูุณูุฉ
  // ============================================================================

  const loadSimpleTree = useCallback(async () => {
    if (!uid) {
      return;
    }
    
    setLoading(true);
    setLoadingStage('ุชุญููู ุนุงุฆูุชู...');
    setLoadingProgress(0);

    try {
      const familySnapshot = await getDocs(collection(db, 'users', uid, 'family'));
      const familyMembers = [];
      
      setLoadingProgress(30);
      
      familySnapshot.forEach(doc => {
        const memberData = sanitizeMemberData({ 
          ...doc.data(), 
          id: doc.id,
          globalId: `${uid}_${doc.id}`,
          familyUid: uid
        });
        
        if (memberData.firstName && memberData.firstName.trim() !== '') {
          familyMembers.push(memberData);
        }
      });

      setLoadingProgress(60);
      setLoadingStage('ุจูุงุก ุงูุดุฌุฑุฉ...');

      const treeData = buildSimpleTreeStructure(familyMembers);
      
      setLoadingProgress(100);
      setLoadingStage('ุงูุชูู ุงูุชุญููู');
      
      setSimpleTreeData(treeData);
      
      // ุชุณุฌูู ููุงููุณ ุงูุฃุฏุงุก
      monitorPerformance({
        personCount: familyMembers.length,
        maxDepthReached: 2,
        familyCount: 1,
        loadTime: 1000
      });
      
      showSnackbar(`โ ุชู ุชุญููู ุนุงุฆูุชู: ${familyMembers.length} ุฃูุฑุงุฏ (ุฑุจ ุงูุนุงุฆูุฉ ูุฃููุงุฏู)`, 'success');

    } catch {
      setError('ูุดู ูู ุชุญููู ุงูุดุฌุฑุฉ');
      showSnackbar('โ ูุดู ูู ุชุญููู ุงูุดุฌุฑุฉ', 'error');
    } finally {
      setLoading(false);
    }
  }, [uid, showSnackbar, monitorPerformance, buildSimpleTreeStructure]);

  // ุฏุงูุฉ ูุณุงุนุฏุฉ ูุญุณุงุจ ุนุฏุฏ ุงูุนูุฏ ูู ุงูุดุฌุฑุฉ
  const countTreeNodes = useCallback((node) => {
    if (!node) return 0;
    
    let count = 1; // ุงูุนูุฏุฉ ุงูุญุงููุฉ
    if (node.children && node.children.length > 0) {
      node.children.forEach(child => {
        count += countTreeNodes(child);
      });
    }
    return count;
  }, []);

  // ุฏุงูุฉ ูุณุงุนุฏุฉ ูุญุณุงุจ ุนูู ุงูุดุฌุฑุฉ ุงูุฐููุฉ
  const calculateSmartTreeDepth = useCallback((node, currentDepth = 0) => {
    if (!node || !node.children || node.children.length === 0) {
      return currentDepth;
    }
    
    return maxDepth;
  }, []);

  // ===========================================================================
  // ุฏูุงู ุงูุชุญููู ุงูุฑุฆูุณูุฉ
  // ============================================================================

  try {
    // ุฅูุดุงุก ูุธุงู ุงูุฑุจุท ุงูุฐูู
    const smartLinking = new SmartTribalLinking();
    
    setLoadingProgress(20);
    setLoadingStage('๏ฟฝ ุชุญููู ุฌููุน ุจูุงูุงุช ุงููุจููุฉ...');
    
    // ุจูุงุก ุงูุดุฌุฑุฉ ุงูุฐููุฉ
    const smartTree = await smartLinking.buildSmartTribalTree(uid);
    
    setLoadingProgress(90);
    setLoadingStage('โก ุชุญุณูู ูุชูุณูู ุงูุดุฌุฑุฉ...');
    
    if (!smartTree) {
      console.warn('โ๏ธ ูุดู ูู ุจูุงุก ุงูุดุฌุฑุฉ ุงูุฐููุฉุ ุงูุฑุฌูุน ููุดุฌุฑุฉ ุงูุจุณูุทุฉ');
      
      // ุงูุฑุฌูุน ููุดุฌุฑุฉ ุงูุจุณูุทุฉ
      const familySnapshot = await getDocs(collection(db, 'users', uid, 'family'));
      const familyMembers = [];
      
      familySnapshot.forEach(doc => {
        const memberData = sanitizeMemberData({ 
          ...doc.data(), 
          id: doc.id,
          globalId: `${uid}_${doc.id}`,
          familyUid: uid
        });
        
        if (memberData.firstName && memberData.firstName.trim() !== '') {
          familyMembers.push(memberData);
        }
      });

      if (familyMembers.length > 0) {
        const simpleTree = buildSimpleTreeStructure(familyMembers);
        setExtendedTreeData(simpleTree);
        showSnackbar('โ๏ธ ุชู ุนุฑุถ ุงูุดุฌุฑุฉ ุงูุจุณูุทุฉ - ูุง ุชูุฌุฏ ุฑูุงุจุท ุฐููุฉ ูุงููุฉ', 'warning');
      } else {
        setError('ูุง ุชูุฌุฏ ุจูุงูุงุช ุนุงุฆูุฉ ูุนุฑุถูุง');
        showSnackbar('โ ูุง ุชูุฌุฏ ุจูุงูุงุช ุนุงุฆูุฉ', 'error');
      }
      return;
    }
    
    // ุญุณุงุจ ุงูููุงููุณ
    const totalPersons = countTreeNodes(smartTree);
    const endTime = Date.now();
    
    // ูุฑุงูุจุฉ ุงูุฃุฏุงุก
    monitorPerformance({
      personCount: totalPersons,
      familyCount: 1, // ุณูุชู ุญุณุงุจูุง ูุงุญูุงู ูู ุงููุธุงู ุงูุฐูู
      maxDepthReached: calculateSmartTreeDepth(smartTree),
      loadTime: endTime - startTime,
      linkingMethod: 'smart_automatic'
    });
    
    setLoadingProgress(100);
    setLoadingStage('โ ุงูุชูู ุจูุงุก ุงูุดุฌุฑุฉ ุงูุฐููุฉ!');
    
    setExtendedTreeData(smartTree);
    
    showSnackbar(`๐ง ุชู ุจูุงุก ุงูุดุฌุฑุฉ ุงูุฐููุฉ ุจู ${totalPersons} ุดุฎุต ุจูุฌุงุญ!`, 'success');

  } catch (error) {
    console.error('โ ุฎุทุฃ ูู ุจูุงุก ุงูุดุฌุฑุฉ ุงูุฐููุฉ:', error);
    setError('ูุดู ูู ุจูุงุก ุงูุดุฌุฑุฉ ุงูุฐููุฉ. ุชุญูู ูู ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช ูุตุญุฉ ุงูุจูุงูุงุช.');
    showSnackbar('โ ูุดู ูู ุจูุงุก ุงูุดุฌุฑุฉ ุงูุฐููุฉ', 'error');
  } finally {
    setLoading(false);
  }
  }, [uid, showSnackbar, monitorPerformance, buildSimpleTreeStructure, countTreeNodes, calculateSmartTreeDepth]);

  const loadLinkedFamilies = useCallback(async () => {
    if (!uid) return;
    
    try {
      const userDoc = await getDoc(doc(db, 'users', uid));
      if (userDoc.exists()) {
        const userData = userDoc.data();
        const linked = userData.linkedFamilies || [];
        setLinkedFamilies(linked);
      }
    } catch {
      // ุฎุทุฃ ุตุงูุช ูู ุชุญููู ุงูุนุงุฆูุงุช ุงููุฑุชุจุทุฉ
    }
  }, [uid]);

  // ===========================================================================
  // ุฏูุงู ุงูุชุญูู
  // ===========================================================================

  const handleRefresh = useCallback(() => {
    // ุชูุธูู ุงูุจูุงูุงุช ุงูุณุงุจูุฉ
    if (showExtendedTree) {
      setExtendedTreeData(null);
      loadExtendedTree();
    } else {
      setSimpleTreeData(null);
      loadSimpleTree();
    }
  }, [showExtendedTree, loadExtendedTree, loadSimpleTree]);

  // ===========================================================================
  // ุฏุงูุฉ ุฑุณู ุงูุดุฌุฑุฉ
  // ===========================================================================

  // ุงุณุชุจุฏู ุฏุงูุฉ drawTreeWithD3 ุจูุฐุง ุงูููุฏ ุงูุฐู ูุญุงูุธ ุนูู ุงูุชุตููู ุงูุฃุตูู ูุน ุฃููููุดู ุจุณูุท:

const drawTreeWithD3 = useCallback((data) => {
  if (!data || !svgRef.current || !containerRef.current) return;

  const screenWidth = window.innerWidth;

  let cardWidth = 220;
  let cardHeight = 110;

  if (screenWidth < 480) {
    cardWidth = 160;
    cardHeight = 90;
  } else if (screenWidth < 768) {
    cardWidth = 190;
    cardHeight = 100;
  }

  const avatarSize = cardHeight * 0.45;
  const padding = 10;
  const textStartX = padding + avatarSize + 16;

  const svg = d3.select(svgRef.current);
  // โ ุฅุตูุงุญ ุฒููู iPhone
  svg
    .style("touch-action", "none")         // ูููุน ุณุญุจ ุงูุตูุญุฉ ูู iOS
    .style("overflow", "visible");         // ูุณูุญ ููุฎุฑูุทุฉ ุจุงูุฎุฑูุฌ ูู svg

  svg.attr('transform', null); 
  svg.property('__zoom', d3.zoomIdentity); 
  svg.selectAll('*').remove(); 

  // ุฅุนุฏุงุฏ ุงูุฃุจุนุงุฏ
  const container = containerRef.current;
  const width = container.clientWidth;
  const height = container.clientHeight;
  svg.attr('width', width).attr('height', height).style('background', 'transparent');

  // โ ุฃูุดุฆ g ุซู ูุนูู ุงูุฒููู ุนููู
  const g = svg.append('g');
  g
    .attr('transform', null)
    .style("touch-action", "manipulation")
    .style("will-change", "transform");

  // ุฅุนุฏุงุฏ ุงูุฒููู ูุฑุจุทู ุนูู g ููุท
  const zoom = d3.zoom()
    .scaleExtent([0.1, 3])
    .on('zoom', (event) => {
      g.attr('transform', event.transform);
    });
    svg.call(zoom);
    svg.property('__zoom', d3.zoomIdentity); 

  // ุฅุนุฏุงุฏ ุจูุงูุงุช ุงูุดุฌุฑุฉ
  const root = d3.hierarchy(data);
  // ุญุณุงุจ ุนูู ุงูุดุฌุฑุฉ (ุนุฏุฏ ุงูุฃุฌูุงู)
  let maxDepth = 1;
  let generationCounts = {};
  let maxBreadth = 1;
  root.each(d => {
    if (d.depth > maxDepth) maxDepth = d.depth;
    generationCounts[d.depth] = (generationCounts[d.depth] || 0) + 1;
    if (generationCounts[d.depth] > maxBreadth) maxBreadth = generationCounts[d.depth];
  });

  // ุชูููุฒ ุจูู ุงูุดุฌุฑุฉ ุงูุนุงุฏูุฉ ูุงูููุณุนุฉ
  let verticalGap, dynamicHeight, horizontalGap, dynamicWidth;
  if (showExtendedTree) {
    // ุงูุดุฌุฑุฉ ุงูููุณุนุฉ: ูุณุงุญุฉ ุฑุฃุณูุฉ ุฃูุจุฑ ููู ููุณุช ูุจุงูุบ ูููุงุ ููุณุงูุฉ ุฃูููุฉ ุฃูุจุฑ
    verticalGap = 80; 
    horizontalGap = 220; 
    dynamicHeight = Math.max(verticalGap * maxDepth, 350);
    dynamicWidth = Math.max(horizontalGap * maxBreadth, width - 100);
  } else {
    verticalGap = 55;
    horizontalGap = 180;
    dynamicHeight = Math.max(verticalGap * maxDepth, 180);
    dynamicWidth = width - 100;
  }

  // ุฅุนุฏุงุฏ ุชุฎุทูุท ุงูุดุฌุฑุฉ ูุน ุชูุฒูุน ุฃููู ูุชุณุงูู ุชูุงูุงู (ุจุฏูู ุฃู ุชุฑุงูุจ)
  const treeLayout = d3.tree()
    .size([dynamicWidth, dynamicHeight])
    .separation(() => {
      // ุชูุฒูุน ุฃููู ูุชุณุงูู ุชูุงูุงู ุจูู ุฌููุน ุงูุนูุฏ ูู ููุณ ุงูุฌูู (1)
      return 1;
    }); 

  treeLayout(root);

  // ุฑุณู ุงูุฑูุงุจุท ูุน ุฃููููุดู ุจุณูุท
  const links = g.selectAll(".link")
    .data(root.links())
    .enter().append("path")
    .attr("class", "link")
    .style("fill", "none")
    .attr("d", d => {
        const source = d.source;
        const target = d.target;
        const midY = source.y + (target.y - source.y) / 2;
        const radius = 18;
        return `M${source.x},${source.y}
                L${source.x},${midY - radius}
                Q${source.x},${midY} ${source.x + (target.x > source.x ? radius : -radius)},${midY}
                L${target.x - (target.x > source.x ? radius : -radius)},${midY}
                Q${target.x},${midY} ${target.x},${midY + radius}
                L${target.x},${target.y}`;
      })
    .style("stroke", "#cbd5e1")
    .style("stroke-width", 2)
    .style("stroke-linecap", "round")
    .style("stroke-linejoin", "round")
    .style("opacity", 0) // ุจุฏุก ูุฎูู ููุฃููููุดู
    .style("filter", "none")
    .style("stroke-dasharray", "none");

  // ุฃููููุดู ุจุณูุท ููุฑูุงุจุท
  links.transition()
    .delay(500)
    .duration(800)
    .ease(d3.easeQuadOut)
    .style("opacity", 0.85);

  // ุฑุณู ุงูุนูุฏ ูุน ุฃููููุดู ุจุณูุท
  const nodes = g.selectAll(".node")
    .data(root.descendants())
    .enter().append("g")
    .attr("class", "node")
    .attr("data-depth", d => d.depth) // ููุฃููููุดู CSS
    .attr("transform", d => `translate(${d.x},${d.y})`)
    .style("opacity", 0); // ุจุฏุก ูุฎูู ููุฃููููุดู

  // ุฃููููุดู ุจุณูุท ููุนูุฏ
  nodes.transition()
    .delay((d, i) => d.depth * 200 + i * 50)
    .duration(600)
    .ease(d3.easeBackOut)
    .style("opacity", 1);

  // ุฅุถุงูุฉ ูุญุชูู ุงูุนูุฏ - ููุณ ุงูุชุตููู ุงูุฃุตูู ุชูุงูุงู
  nodes.each(function(d) {
  const nodeGroup = d3.select(this);
  const nodeData = d.data.attributes || d.data;
  
  const uniqueId = nodeData.id || nodeData.globalId || Math.random().toString(36).substring(7);
  const name = nodeData.name || `${nodeData.firstName || ''} ${nodeData.fatherName || ''}`.trim() || '';
  const relation = nodeData.relation || 'ุนุถู';
  const nameY = -cardHeight / 2 + padding + 14;
  const relationY = nameY + 18;
  const childBoxWidth = 40;
  const childBoxHeight = 16;
  const childBoxX = -cardWidth / 2 + padding;
  const childBoxY = cardHeight / 2 - childBoxHeight - 4;
  const childTextX = childBoxX + childBoxWidth / 2;
  const childTextY = childBoxY + childBoxHeight / 2 + 1.5;
  const ageBoxWidth = 40;
  const ageBoxHeight = 16;
  const ageBoxX = cardWidth / 2 - padding - ageBoxWidth;
  const ageBoxY = cardHeight / 2 - ageBoxHeight - 4;
  const ageTextX = ageBoxX + ageBoxWidth / 2;
  const ageTextY = ageBoxY + ageBoxHeight / 2 + 1.5;
  // ุนูุฑ ูุญุณูุจ
  const calculateAge = (birthdate) => {
    if (!birthdate) return '';
    const birth = new Date(birthdate);
    const today = new Date();
    if (isNaN(birth.getTime())) return '';
    let age = today.getFullYear() - birth.getFullYear();
    const m = today.getMonth() - birth.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
    return age > 0 ? age : '';
  };
  const age = calculateAge(nodeData.birthdate || nodeData.birthDate);

  // ุงููุงุฑุช
  // ๐ฆ ุชุญุฏูุฏ ุงูุฃููุงู ุญุณุจ ุงูุฌูุณ
  let cardFill = "#f3f4f6";
  let cardStroke = "#cbd5e1";

  if (nodeData.gender === "male" || relation.includes("ุงุจู")) {
    cardFill = "#e3f2fd";
    cardStroke = "#2196f3";
  } else if (nodeData.gender === "female" || relation.includes("ุจูุช")) {
    cardFill = "#fce4ec";
    cardStroke = "#e91e63";
  }

  nodeGroup.append("rect")
    .attr("width", cardWidth)
    .attr("height", cardHeight)
    .attr("x", -cardWidth / 2)
    .attr("y", -cardHeight / 2)
    .attr("rx", 14)
    .attr("fill", cardFill)
    .attr("stroke", cardStroke)
    .attr("stroke-width", 2)
    .attr("class", "family-node-card");

  // ุตูุฑุฉ ุฃู ุฃูุงุชุงุฑ
  // โญ๏ธ ุฏุงุฆุฑุฉ ุฎูููุฉ ุงูุตูุฑุฉ
nodeGroup.append("circle")
  .attr("cx", -cardWidth / 2 + padding + avatarSize / 2)
  .attr("cy", -cardHeight / 2 + padding + avatarSize / 2)
  .attr("r", avatarSize / 2)
  .attr("fill", "#fff")
  .attr("stroke", "#ddd")
  .attr("stroke-width", 1.5);

// ๐ข ClipPath ุฏุงุฆุฑู ููุตูุฑุฉ
nodeGroup.append("clipPath")
  .attr("id", `avatar-circle-${uniqueId}`)
  .append("circle")
  .attr("cx", -cardWidth / 2 + padding + avatarSize / 2)
  .attr("cy", -cardHeight / 2 + padding + avatarSize / 2)
  .attr("r", avatarSize / 2);

// ๐ผ๏ธ ุตูุฑุฉ ุฏุงุฎู ุงูุฏุงุฆุฑุฉ ูุน ุชูุทูุน ูุชูุณูุท
nodeGroup.append("image")
  .attr("href",
    nodeData.avatar ||
    (nodeData.gender === "female" || relation.includes("ุจูุช")
      ? "/icons/girl.png"
      : "/icons/boy.png")
  )
  .attr("x", -cardWidth / 2 + padding)
  .attr("y", -cardHeight / 2 + padding)
  .attr("width", avatarSize)
  .attr("height", avatarSize)
  .attr("clip-path", `url(#avatar-circle-${uniqueId})`)
  .attr("preserveAspectRatio", "xMidYMid slice");

  // ุงูุงุณู
  nodeGroup.append("text")
    .text(name.length > 22 ? name.slice(0, 20) + 'โฆ' : name)
    .attr("x", textStartX)
    .attr("y", nameY)
    .attr("font-size", 13)
    .attr("font-weight", "bold")
    .attr("fill", "#111");

  // ุงูุนูุงูุฉ
  nodeGroup.append("text")
    .text(relation)
    .attr("x", textStartX)
    .attr("y", relationY)
    .attr("font-size", 11)
    .attr("fill", "#666");

  if (age) {
  // ุงูุฎูููุฉ
  nodeGroup.append("rect")
    .attr("x", ageBoxX)
    .attr("y", ageBoxY)
    .attr("width", ageBoxWidth)
    .attr("height", ageBoxHeight)
    .attr("rx", 8)
    .attr("fill", "rgba(25, 118, 210, 0.08)")
    .attr("stroke", "#1976d2")
    .attr("stroke-width", 0.8);

  // ุงููุต ูู ุงูููุชุตู ุชูุงููุง
  nodeGroup.append("text")
  .text(age + " ุณูุฉ") // ุฅุถุงูุฉ ูููุฉ ุณูุฉ ุจุฌุงูุจ ุงูุนูุฑ
  .attr("x", ageTextX)
  .attr("y", ageTextY)
  .attr("font-size", 10)
  .attr("fill", "#1976d2")
  .attr("font-weight", "600")
  .attr("text-anchor", "middle")
  .attr("dominant-baseline", "middle");
}

  // โ ุงูุฎูููุฉ ุฎูู ุนุฏุฏ ุงูุฃุทูุงู
  if (d.children && d.children.length > 0) {
    const childText = ` ${d.children.length}`;
  nodeGroup.append("rect")
    .attr("x", childBoxX)
    .attr("y", childBoxY)
    .attr("width", childBoxWidth)
    .attr("height", childBoxHeight)
    .attr("rx", 8)
    .attr("fill", "rgba(76, 175, 80, 0.08)")
    .attr("stroke", "#4caf50")
    .attr("stroke-width", 0.8);

  nodeGroup.append("text")
    .text(childText)
    .attr("x", childTextX)
    .attr("y", childTextY)
    .attr("font-size", 10)
    .attr("fill", "#4caf50")
    .attr("font-weight", "600")
    .attr("text-anchor", "middle")
    .attr("dominant-baseline", "middle");
}

if (searchQuery.length > 1 && name.toLowerCase().includes(searchQuery.toLowerCase())) {
  nodeGroup.select("rect.family-node-card")
    .transition()
    .duration(600)
    .attr("stroke", "#f59e0b")
    .attr("stroke-width", 3);
}

  // ุนูุฏ ุงูุถุบุท
  nodeGroup.on("click", () => {
    handleNodeClick?.({
      ...nodeData,
      name,
      age,
      children: d.children || []
    });
  });
});

  // ูุนุงูุฌุฉ ุชุฏุงุฎู ุงูุนูุฏ - ููุณ ุงูุทุฑููุฉ ุงูุฃุตููุฉ
  const nodesByDepth = {};
  root.each(d => {
    if (!nodesByDepth[d.depth]) nodesByDepth[d.depth] = [];
    nodesByDepth[d.depth].push(d);
  });
  
  Object.values(nodesByDepth).forEach(nodes => {
    nodes.sort((a, b) => a.x - b.x);
    for (let i = 1; i < nodes.length; i++) {
      const prev = nodes[i - 1];
      const curr = nodes[i];
      // ุฅุฐุง ูุงู ููุงู ุชุฏุงุฎู ุฃู ุชูุงุทุน ุจูู ุงููุฑูุชุ ูุญุฑู ุงูุนูุฏุฉ ุงูุญุงููุฉ ููููุงู
      const minDistance = 340; 
      if (curr.x - prev.x < minDistance) {
        const shift = minDistance - (curr.x - prev.x);
        curr.x += shift;
        // ุฅุนุงุฏุฉ ุถุจุท x ูุฌููุน ุงูุฃุจูุงุก ุฃูุถุงู
        function shiftChildren(node, delta) {
          if (node.children && node.children.length > 0) {
            node.children.forEach(child => {
              child.x += delta;
              shiftChildren(child, delta);
            });
          }
        }
        shiftChildren(curr, shift);
      }
    }
  });

  // ุชูุฑูุฒ ุชููุงุฆู ุจุณูุท (ุงุฎุชูุงุฑู)
  setTimeout(() => {
    if (svgRef.current && containerRef.current) {
      const svg = d3.select(svgRef.current);
      const g = svg.select('g');
      
      try {
        const bounds = g.node().getBBox();
        const fullWidth = bounds.width;
        const fullHeight = bounds.height;
        
        if (fullWidth > 0 && fullHeight > 0) {
          const scale = Math.min(
            (width * 0.9) / fullWidth,
            (height * 0.9) / fullHeight,
            1.2
          );
          
          const centerX = bounds.x + fullWidth / 2;
          const centerY = bounds.y + fullHeight / 2;
          const targetX = width / 2 - centerX * scale;
          const targetY = height / 2 - centerY * scale;
          
          svg.transition()
            .duration(1500)
            .ease(d3.easeCubicInOut)
            .call(
              zoom.transform,
              d3.zoomIdentity
                .translate(targetX, targetY)
                .scale(scale)
            );
        }
      } catch {
        // Removed unused 'error'
      }
    }
  }, 1200);

}, [showExtendedTree, handleNodeClick, searchQuery]);

  // ุฏุงูุฉ ุงูุจุญุซ ุงููุญููุฉ - ูุจุณุทุฉ
  const performSearch = useCallback((query) => {
    if (!query || query.trim().length < 2) {
      // ุฅุฒุงูุฉ ุงูุชููุฒ ุฅุฐุง ูุงู ุงูุจุญุซ ูุงุฑุบ
      if (svgRef.current) {
        const svg = d3.select(svgRef.current);
        svg.selectAll('.node rect')
          .style('stroke', '#ddd')
          .style('stroke-width', '2px');
        svg.selectAll('.node text')
          .style('font-weight', 'normal');
      }
      return;
    }
    
    const queryLower = query.trim().toLowerCase();
    
    if (svgRef.current) {
      const svg = d3.select(svgRef.current);
      
      // ุฅุนุงุฏุฉ ุชุนููู ูู ุงูุนูุฏ ูุญุงูุชูุง ุงูุทุจูุนูุฉ ุฃููุงู
      svg.selectAll('.node rect')
        .style('stroke', '#ddd')
        .style('stroke-width', '2px');
      svg.selectAll('.node text')
        .style('font-weight', 'normal');
      
      // ุงูุจุญุซ ูุชููุฒ ุงูุนูุฏ ุงููุทุงุจูุฉ
      svg.selectAll('.node').each(function(d) {
        const name = d.data?.name?.toLowerCase() || '';
        if (name.includes(queryLower)) {
          // ุชููุฒ ุงูุนูุฏุฉ ุงููุทุงุจูุฉ
          d3.select(this).select('rect')
            .style('stroke', '#ffeb3b')
            .style('stroke-width', '4px');
          d3.select(this).select('text')
            .style('font-weight', 'bold');
        }
      });
    }
  }, []);

  // ===========================================================================
  // ุชุฃุซูุฑุงุช ูุฏูุฑุฉ ุงูุญูุงุฉ
  // ===========================================================================

  useEffect(() => {
    if (!uid) {
      navigate('/login');
      return;
    }

    loadSimpleTree();
    loadLinkedFamilies();
  }, [uid, navigate, loadSimpleTree, loadLinkedFamilies]);

  useEffect(() => {
    if (!uid) return;
    
    if (showExtendedTree && !extendedTreeData) {
      loadExtendedTree();
    }
  }, [showExtendedTree, uid, extendedTreeData, loadExtendedTree]);

  // ุชุฃุซูุฑ ุฑุณู ุงูุดุฌุฑุฉ
  useEffect(() => {
    const currentTreeData = showExtendedTree ? extendedTreeData : simpleTreeData;
    if (currentTreeData && svgRef.current && containerRef.current) {
      const timer = setTimeout(() => {
        drawTreeWithD3(currentTreeData);
      }, 200);
      
      return () => clearTimeout(timer);
    }
  }, [drawTreeWithD3, showExtendedTree, simpleTreeData, extendedTreeData]);

  // ุชุฃุซูุฑ ุงูุจุญุซ
  useEffect(() => {
    performSearch(searchQuery);
  }, [searchQuery, performSearch]);

  // ุชูุธูู ุนูุฏ ุฅูุบุงุก ุงูุชุญููู
  useEffect(() => {
    const currentReactRoots = reactRootsRef.current;
    return () => {
      currentReactRoots.forEach(root => {
        try {
          if (!ReactDOM.unstable_isNewReconciler) {
            root.unmount();
          }
        } catch {
          // Silent cleanup
        }
      });
      currentReactRoots.clear();
    };
  }, []);

  // ===========================================================================
  // ูุงุฌูุฉ ุงููุณุชุฎุฏู
  // ===========================================================================

  const renderTreeView = () => {
    const currentTreeData = showExtendedTree ? extendedTreeData : simpleTreeData;
    const treeTitle = showExtendedTree ? 'ุงูุดุฌุฑุฉ ุงูููุณุนุฉ ูููุจููุฉ' : 'ุดุฌุฑุฉ ุนุงุฆูุชู';
    
    return (
      <Box
        ref={containerRef}
        sx={{
          position: 'absolute',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          overflow: 'hidden',
          background: '#fff', 
          fontFamily: 'Cairo, sans-serif'
        }}
      >
        {error ? (
          <Box
            display="flex"
            flexDirection="column"
            justifyContent="center"
            alignItems="center"
            height="100%"
            sx={{ color: '#ef4444', textAlign: 'center' }}
          >
            <WarningIcon sx={{ fontSize: 80, mb: 2 }} />
            <Typography variant="h5" sx={{ mb: 2, fontFamily: 'Cairo, sans-serif' }}>
              ุญุฏุซ ุฎุทุฃ ูู ุงูุชุญููู
            </Typography>
            <Typography variant="body1" sx={{ mb: 3, fontFamily: 'Cairo, sans-serif' }}>
              {error}
            </Typography>
            <Button 
              variant="contained" 
              onClick={handleRefresh}
              startIcon={<RefreshIcon />}
              sx={{ fontFamily: 'Cairo, sans-serif' }}
            >
              ุฅุนุงุฏุฉ ุงููุญุงููุฉ
            </Button>
          </Box>
        ) : currentTreeData ? (
          <svg
            ref={svgRef}
            width="100%"
            height="100%"
            style={{ 
              cursor: 'grab', 
              userSelect: 'none',
              background: 'transparent'
            }}
            onMouseDown={(e) => e.currentTarget.style.cursor = 'grabbing'}
            onMouseUp={(e) => e.currentTarget.style.cursor = 'grab'}
            onMouseLeave={(e) => e.currentTarget.style.cursor = 'grab'}
          />
        ) : (
          <Box
            display="flex"
            flexDirection="column"
            justifyContent="center"
            alignItems="center"
            height="100%"
            sx={{ color: '#f8fafc', textAlign: 'center' }}
          >
            {loading ? (
              <Box textAlign="center" maxWidth={600}>
                <CircularProgress size={80} sx={{ color: showExtendedTree ? '#8b5cf6' : '#10b981', mb: 3 }} />
                <Typography variant="h5" sx={{ mb: 2, fontFamily: 'Cairo, sans-serif' }}>
                  {loadingStage || `ุฌุงุฑู ุชุญููู ${treeTitle}...`}
                </Typography>
                <LinearProgress 
                  variant="determinate" 
                  value={loadingProgress} 
                  sx={{ 
                    width: '100%', 
                    height: 8, 
                    borderRadius: 4, 
                    mb: 2,
                    backgroundColor: 'rgba(255,255,255,0.1)',
                    '& .MuiLinearProgress-bar': {
                      backgroundColor: showExtendedTree ? '#8b5cf6' : '#10b981'
                    }
                  }}
                />
                <Typography variant="body2" sx={{ color: showExtendedTree ? '#8b5cf6' : '#10b981', fontFamily: 'Cairo, sans-serif' }}>
                  {Math.round(loadingProgress)}% ููุชูู
                </Typography>
              </Box>
            ) : (
              <Box textAlign="center">
                <AccountTreeIcon sx={{ fontSize: 120, color: showExtendedTree ? '#8b5cf6' : '#10b981', mb: 2 }} />
                <Typography variant="h4" sx={{ mb: 1, fontFamily: 'Cairo, sans-serif', color: showExtendedTree ? '#8b5cf6' : '#10b981' }}>
                  {showExtendedTree ? '๐๏ธ ุงุจูู ุดุฌุฑุฉ ูุจููุชู ุงูููุณุนุฉ' : '๐ณ ุงุจูู ุดุฌุฑุฉ ุนุงุฆูุชู'}
                </Typography>
                <Typography variant="body1" sx={{ color: 'text.secondary', mb: 3, maxWidth: 500, fontFamily: 'Cairo, sans-serif' }}>
                  {showExtendedTree 
                    ? '๐ ุงุฑุจุท ุนุงุฆูุชู ูุน ุงูุนุงุฆูุงุช ุงูุฃุฎุฑู ูุจูุงุก ุดุฌุฑุฉ ูุจููุฉ ุดุงููุฉ ุชุถู ุฌููุน ุงูุฃูุงุฑุจ ูุงููุฑูุน'
                    : '๐จโ๐ฉโ๐งโ๐ฆ ุฃุถู ุฃูุฑุงุฏ ุนุงุฆูุชู ุงููุจุงุดุฑูู: ุฑุจ ุงูุนุงุฆูุฉ ูุฃููุงุฏู ูุจูุงุชู'
                  }
                </Typography>
                <Box display="flex" gap={2} justifyContent="center">
                  <Button
                    variant="contained"
                    sx={{ 
                      backgroundColor: '#10b981',
                      '&:hover': { backgroundColor: '#059669' },
                      fontFamily: 'Cairo, sans-serif'
                    }}
                    size="large"
                    onClick={() => navigate('/family')}
                    startIcon={<PersonIcon />}
                  >
                    ุฅุถุงูุฉ ุฃูุฑุงุฏ ุงูุนุงุฆูุฉ
                  </Button>
                  <Button
                    variant="outlined"
                    sx={{ 
                      borderColor: showExtendedTree ? '#8b5cf6' : '#10b981',
                      color: showExtendedTree ? '#8b5cf6' : '#10b981',
                      '&:hover': { 
                        borderColor: showExtendedTree ? '#7c3aed' : '#059669',
                        backgroundColor: showExtendedTree ? 'rgba(139, 92, 246, 0.1)' : 'rgba(16, 185, 129, 0.1)'
                      },
                      fontFamily: 'Cairo, sans-serif'
                    }}
                    size="large"
                    onClick={() => setShowLinkingPanel(true)}
                    startIcon={<LinkIcon />}
                  >
                    ุฑุจุท ุนุงุฆูุงุช
                  </Button>
                </Box>
              </Box>
            )}
          </Box>
        )}
      </Box>
    );
  };

  const renderToolbar = () => (
    <Paper
      elevation={8}
      sx={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        zIndex: 1000,
        background: 'linear-gradient(145deg, rgba(255,255,255,0.98) 0%, rgba(249,250,251,0.98) 50%, rgba(243,244,246,0.98) 100%)',
        backdropFilter: 'blur(25px)',
        borderBottom: '1px solid rgba(0,0,0,0.08)',
        boxShadow: '0 4px 32px rgba(0,0,0,0.12), 0 2px 8px rgba(0,0,0,0.08)',
        '&::before': {
          content: '""',
          position: 'absolute',
          bottom: 0,
          left: 0,
          right: 0,
          height: '2px',
          background: showExtendedTree 
            ? 'linear-gradient(90deg, #8b5cf6 0%, #d946ef 100%)' 
            : 'linear-gradient(90deg, #10b981 0%, #059669 100%)',
          transition: 'all 0.3s ease'
        }
      }}
    >
      {/* Container ุงูุฑุฆูุณู ูุน ุชุตููู ูุชุฌุงูุจ ูุงุฑุชูุงุน ูููู */}
      <Box sx={{ 
        px: { xs: 1, sm: 2, md: 3 }, 
        py: { xs: 0.5, sm: 1 },
        maxWidth: '1400px',
        margin: '0 auto'
      }}>
        
        {/* ุงูุนููุงู ูุงููุตู - ุงุฑุชูุงุน ูููู */}
        <Box sx={{ textAlign: 'center', mb: 1 }}>
          <Typography 
            variant="h5" 
            sx={{ 
              mb: 0,
              fontSize: { xs: '1.25rem', sm: '1.5rem', md: '1.75rem' },
              color: showExtendedTree ? '#8b5cf6' : '#10b981',
              fontWeight: 700,
              fontFamily: 'Cairo, sans-serif',
              transition: 'all 0.3s ease',
              textShadow: '0 1px 2px rgba(0,0,0,0.1)',
              background: showExtendedTree 
                ? 'linear-gradient(45deg, #8b5cf6 0%, #d946ef 100%)' 
                : 'linear-gradient(45deg, #10b981 0%, #059669 100%)',
              backgroundClip: 'text',
              WebkitBackgroundClip: 'text',
              WebkitTextFillColor: 'transparent'
            }}
          >
            {showExtendedTree ? '๐๏ธ ุงูุดุฌุฑุฉ ุงูููุณุนุฉ ูููุจููุฉ' : '๐ณ ุดุฌุฑุฉ ุนุงุฆูุชู'}
          </Typography>
          
          <Typography 
            variant="caption" 
            sx={{ 
              color: 'text.secondary',
              fontFamily: 'Cairo, sans-serif',
              fontSize: { xs: '0.7rem', sm: '0.75rem' },
              opacity: 0.8,
              maxWidth: '600px',
              margin: '0 auto',
              display: 'block'
            }}
          >
            {showExtendedTree 
              ? '๐ ุงุณุชูุดู ุฌููุน ุงูุนุงุฆูุงุช ุงููุฑุชุจุทุฉ ูู ุดุฌุฑุฉ ููุญุฏุฉ ูุดุงููุฉ' 
              : '๐จโ๐ฉโ๐งโ๐ฆ ุนุฑุถ ุจุณูุท ูุฑุจ ุงูุนุงุฆูุฉ ูุฃููุงุฏู ุงููุจุงุดุฑูู'
            }
          </Typography>
        </Box>

        {/* ุดุฑูุท ุงูุชุญููู - ุงุฑุชูุงุน ูููู */}
        {loading && (
          <LinearProgress 
            variant="determinate" 
            value={loadingProgress} 
            sx={{ 
              mb: 1,
              height: 6, 
              borderRadius: 3,
              backgroundColor: 'rgba(0,0,0,0.06)',
              '& .MuiLinearProgress-bar': {
                background: showExtendedTree 
                  ? 'linear-gradient(90deg, #8b5cf6 0%, #d946ef 100%)' 
                  : 'linear-gradient(90deg, #10b981 0%, #059669 100%)',
                borderRadius: 3,
                boxShadow: '0 1px 4px rgba(0,0,0,0.2)'
              }
            }}
          />
        )}

        {/* ุงูุฃุฒุฑุงุฑ ุงูุฑุฆูุณูุฉ - ุฃุญุฌุงู ููููุฉ */}
        <Box sx={{ 
          display: 'flex', 
          justifyContent: 'center', 
          gap: { xs: 0.5, sm: 1 }, 
          flexWrap: 'wrap', 
          mb: 1,
          alignItems: 'center'
        }}>
          {/* ุฃุฒุฑุงุฑ ุงูุฅุฌุฑุงุกุงุช ุงูุฃุณุงุณูุฉ */}
          <Button 
            variant="contained" 
            size={window.innerWidth < 600 ? "small" : "medium"}
            onClick={() => navigate('/family')} 
            disabled={loading} 
            startIcon={<PersonAddIcon />} 
            sx={{ 
              px: { xs: 1, sm: 1.5 },
              py: { xs: 0.25, sm: 0.5 },
              fontSize: { xs: '0.7rem', sm: '0.8rem' },
              borderRadius: 2,
              background: 'linear-gradient(45deg, #1976d2 0%, #1565c0 100%)',
              boxShadow: '0 2px 8px rgba(25,118,210,0.25)',
              '&:hover': { 
                background: 'linear-gradient(45deg, #1565c0 0%, #0d47a1 100%)',
                transform: 'translateY(-1px)',
                boxShadow: '0 4px 12px rgba(25,118,210,0.3)'
              },
              transition: 'all 0.2s ease'
            }}
          >
            ุฅุฏุงุฑุฉ ุงูุนุงุฆูุฉ
          </Button>

          <Button 
            variant="outlined" 
            size={window.innerWidth < 600 ? "small" : "medium"}
            onClick={() => setShowLinkingPanel(true)} 
            disabled={loading} 
            startIcon={<LinkIcon />} 
            sx={{ 
              px: { xs: 1, sm: 1.5 },
              py: { xs: 0.25, sm: 0.5 },
              fontSize: { xs: '0.7rem', sm: '0.8rem' },
              borderRadius: 2,
              borderColor: '#8b5cf6',
              color: '#8b5cf6',
              '&:hover': {
                borderColor: '#7c3aed',
                backgroundColor: 'rgba(139,92,246,0.05)',
                transform: 'translateY(-1px)',
                boxShadow: '0 2px 8px rgba(139,92,246,0.15)'
              },
              transition: 'all 0.2s ease'
            }}
          >
            ุฑุจุท ุงูุนุงุฆูุงุช
          </Button>

          <Button 
            variant="contained" 
            size={window.innerWidth < 600 ? "small" : "medium"}
            onClick={() => navigate('/statistics')}
            disabled={loading} 
            startIcon={<BarChartIcon />} 
            sx={{ 
              px: { xs: 1, sm: 1.5 },
              py: { xs: 0.25, sm: 0.5 },
              fontSize: { xs: '0.7rem', sm: '0.8rem' },
              borderRadius: 2,
              background: 'linear-gradient(45deg, #10b981 0%, #059669 100%)',
              boxShadow: '0 2px 8px rgba(16,185,129,0.25)',
              '&:hover': { 
                background: 'linear-gradient(45deg, #059669 0%, #047857 100%)',
                transform: 'translateY(-1px)',
                boxShadow: '0 4px 12px rgba(16,185,129,0.3)'
              },
              transition: 'all 0.2s ease'
            }}
          >
            ุงูุฅุญุตุงุฆูุงุช
          </Button>

          {/* ุฒุฑ ุงูุชุญุฏูุซ */}
          <IconButton 
            onClick={handleRefresh} 
            disabled={loading} 
            size={window.innerWidth < 600 ? "small" : "medium"}
            sx={{ 
              ml: 0.5,
              borderRadius: 1.5,
              background: 'rgba(0,0,0,0.04)',
              '&:hover': {
                background: 'rgba(0,0,0,0.08)',
                transform: 'rotate(180deg) scale(1.05)',
              },
              transition: 'all 0.2s ease'
            }}
            title="ุฅุนุงุฏุฉ ุชุญููู ุงูุดุฌุฑุฉ"
          >
            <RefreshIcon />
          </IconButton>
        </Box>

        {/* ุดุฑูุท ุงูุจุญุซ ุงููุญุณู - ุงุฑุชูุงุน ูููู */}
        <Box sx={{ 
          display: 'flex', 
          justifyContent: 'center', 
          mb: 1,
          px: { xs: 1, sm: 0 }
        }}>
          <TextField
            size="small"
            value={searchQuery}
            onChange={(e) => {
              const value = e.target.value;
              setSearchQuery(value);
              performSearch(value);
            }}
            placeholder="๐ ุงุจุญุซ ุนู ุฃู ุดุฎุต ูู ุงูุดุฌุฑุฉ ููุชุฑููุฒ ุนููู..."
            variant="outlined"
            sx={{
              width: { xs: '100%', sm: '350px', md: '450px' },
              '& .MuiOutlinedInput-root': {
                backgroundColor: 'rgba(255, 255, 255, 0.7)',
                borderRadius: 3,
                fontFamily: 'Cairo, sans-serif',
                fontSize: { xs: '0.8rem', sm: '0.9rem' },
                backdropFilter: 'blur(10px)',
                border: '1px solid rgba(0,0,0,0.08)',
                '&:hover': {
                  backgroundColor: 'rgba(255, 255, 255, 0.9)',
                  boxShadow: '0 2px 12px rgba(0,0,0,0.06)'
                },
                '&.Mui-focused': {
                  backgroundColor: 'rgba(255, 255, 255, 0.95)',
                  boxShadow: `0 0 0 2px ${showExtendedTree ? 'rgba(139,92,246,0.2)' : 'rgba(16,185,129,0.2)'}`,
                  borderColor: showExtendedTree ? '#8b5cf6' : '#10b981'
                },
                transition: 'all 0.2s ease'
              }
            }}
            InputProps={{
              startAdornment: (
                <InputAdornment position="start">
                  <SearchIcon sx={{ color: 'text.secondary', fontSize: '1.2rem' }} />
                </InputAdornment>
              ),
              endAdornment: searchQuery && (
                <InputAdornment position="end">
                  <IconButton 
                    size="small" 
                    onClick={() => {
                      setSearchQuery('');
                      if (svgRef.current) {
                        const svg = d3.select(svgRef.current);
                        const g = svg.select('g');
                        g.selectAll('.node').classed('search-highlight', false);
                        g.selectAll('.node foreignObject > div')
                          .classed('search-highlight', false)
                          .style('transform', null)
                          .style('border', null)
                          .style('box-shadow', null)
                          .style('background', null);
                      }
                    }}
                    sx={{ 
                      '&:hover': { 
                        backgroundColor: 'rgba(244,67,54,0.1)',
                        color: '#f44336'
                      } 
                    }}
                  >
                    <CloseIcon fontSize="small" />
                  </IconButton>
                </InputAdornment>
              )
            }}
          />
        </Box>

        {/* ููุชุงุญ ุชุจุฏูู ููุน ุงูุดุฌุฑุฉ ูุญุณู - ุงุฑุชูุงุน ูููู */}
        <Box sx={{ display: 'flex', justifyContent: 'center', mb: 1 }}>
          <FormControlLabel
            control={
              <Switch
                checked={showExtendedTree}
                onChange={(e) => setShowExtendedTree(e.target.checked)}
                disabled={loading}
                size="small"
                sx={{
                  '& .MuiSwitch-switchBase.Mui-checked': {
                    color: '#8b5cf6',
                  },
                  '& .MuiSwitch-switchBase.Mui-checked + .MuiSwitch-track': {
                    backgroundColor: '#8b5cf6',
                  },
                  '& .MuiSwitch-switchBase': {
                    color: '#10b981',
                  },
                  '& .MuiSwitch-track': {
                    backgroundColor: '#10b981',
                  },
                }}
              />
            }
            label={
              <Box sx={{ textAlign: 'center' }}>
                <Typography 
                  variant="body2" 
                  sx={{ 
                    fontFamily: 'Cairo, sans-serif', 
                    fontWeight: 'bold',
                    fontSize: { xs: '0.75rem', sm: '0.85rem' }
                  }}
                >
                  {showExtendedTree ? '๐๏ธ ุงูุดุฌุฑุฉ ุงูููุณุนุฉ (ุงููุจููุฉ)' : '๐ณ ุงูุดุฌุฑุฉ ุงูุนุงุฏูุฉ (ุงูุนุงุฆูุฉ)'}
                </Typography>
                <Typography 
                  variant="caption" 
                  sx={{ 
                    fontFamily: 'Cairo, sans-serif', 
                    color: 'text.secondary',
                    display: 'block',
                    fontSize: { xs: '0.65rem', sm: '0.7rem' }
                  }}
                >
                  {showExtendedTree ? 'ุฌููุน ุงูุนุงุฆูุงุช ุงููุฑุชุจุทุฉ' : 'ุฑุจ ุงูุนุงุฆูุฉ ูุฃููุงุฏู ููุท'}
                </Typography>
              </Box>
            }
            sx={{
              '& .MuiFormControlLabel-label': {
                px: 0.5
              }
            }}
          />
        </Box>

        {/* ุฅุญุตุงุฆูุงุช ุงูุฃุฏุงุก - ุฃุญุฌุงู ููููุฉ */}
        {performanceMetrics.personCount > 0 && (
          <Box sx={{ 
            display: 'flex', 
            justifyContent: 'center', 
            gap: { xs: 0.5, sm: 0.75 }, 
            flexWrap: 'wrap',
            alignItems: 'center'
          }}>
            <Chip 
              size="small" 
              label={`๐ฅ ${performanceMetrics.personCount} ุดุฎุต`} 
              variant="outlined"
              sx={{
                fontSize: { xs: '0.6rem', sm: '0.7rem' },
                height: { xs: 20, sm: 24 }
              }}
            />
            
            {showExtendedTree && (
              <>
                {performanceMetrics.familyCount > 1 && (
                  <Chip 
                    size="small" 
                    label={`๐๏ธ ${performanceMetrics.familyCount} ุนุงุฆูุฉ`} 
                    variant="outlined" 
                    color="secondary"
                    sx={{
                      fontSize: { xs: '0.6rem', sm: '0.7rem' },
                      height: { xs: 20, sm: 24 }
                    }}
                  />
                )}
                
                {linkedFamilies.length > 0 && (
                  <Chip 
                    size="small" 
                    label={`๐ ${linkedFamilies.length} ุฑุงุจุท`} 
                    variant="outlined" 
                    color="primary"
                    sx={{
                      fontSize: { xs: '0.6rem', sm: '0.7rem' },
                      height: { xs: 20, sm: 24 }
                    }}
                  />
                )}
                
                {performanceMetrics.maxDepthReached > 0 && (
                  <Chip 
                    size="small" 
                    label={`๐ ${performanceMetrics.maxDepthReached + 1} ุฌูู`} 
                    variant="outlined" 
                    color="info"
                    sx={{
                      fontSize: { xs: '0.6rem', sm: '0.7rem' },
                      height: { xs: 20, sm: 24 }
                    }}
                  />
                )}
              </>
            )}
            
            {!showExtendedTree && (
              <Chip 
                size="small" 
                label="๐ณ ุดุฌุฑุฉ ุจุณูุทุฉ (ุฌููุงู)" 
                variant="outlined" 
                color="success"
                sx={{
                  fontSize: { xs: '0.6rem', sm: '0.7rem' },
                  height: { xs: 20, sm: 24 }
                }}
              />
            )}
          </Box>
        )}
      </Box>
    </Paper>
  );

  return (
    <Box className="family-tree-advanced-root" sx={{ width: '100vw', height: '100vh', fontFamily: 'Cairo, sans-serif' }}>
      {renderToolbar()}
      <Box sx={{ position: 'absolute', top: 120, left: 0, right: 0, bottom: 0 }}>
        {renderTreeView()}
      </Box>

      {/* ุงูุญูุงุฑุงุช */}
      <Dialog open={showLinkingPanel} onClose={() => setShowLinkingPanel(false)} maxWidth="lg" fullWidth>
        <DialogTitle>๐ ุฑุจุท ุงูุนุงุฆูุงุช ููุดุฌุฑุฉ ุงูููุณุนุฉ</DialogTitle>
        <DialogContent>
          <ExtendedFamilyLinking
            currentUserUid={uid}
            onLinkingComplete={() => {
              setShowLinkingPanel(false);
              setExtendedTreeData(null);
              // ุชุญุฏูุซ ูุงุฆูุฉ ุงูุนุงุฆูุงุช ุงููุฑุชุจุทุฉ
              loadLinkedFamilies();
              if (showExtendedTree) {
                loadExtendedTree();
              }
            }}
            existingLinks={linkedFamilies.map(link => link.targetFamilyUid)}
          />
        </DialogContent>
      </Dialog>

      <Dialog open={!!selectedNode} onClose={() => setSelectedNode(null)} maxWidth="sm" fullWidth>
        <DialogTitle sx={{ color: '#1976d2', fontWeight: 'bold', fontFamily: 'Cairo, sans-serif' }}>
          {(selectedNode?.gender === 'female' || selectedNode?.relation === 'ุจูุช') ? 'โ๏ธ' : 'โ๏ธ'} {selectedNode?.name || 'ุชูุงุตูู ุงูุดุฎุต'}
        </DialogTitle>
        <DialogContent>
          {selectedNode && (
            <Box sx={{ p: 1 }}>
              <Typography variant="h6" gutterBottom sx={{ fontFamily: 'Cairo, sans-serif' }}>
                {selectedNode.name || buildFullName(selectedNode) || ''}
              </Typography>
              <Box sx={{ mb: 2, display: 'flex', gap: 1, flexWrap: 'wrap' }}>
                <Chip label={selectedNode.relation || ''} color="primary" variant="outlined" />
                {selectedNode.isExtended && (
                  <Chip label="ุนุงุฆูุฉ ูุฑุชุจุทุฉ" color="secondary" variant="outlined" />
                )}
                {selectedNode.familyName && (
                  <Chip label={selectedNode.familyName} color="info" variant="outlined" />
                )}
              </Box>
              {selectedNode.age && <Typography variant="body2" sx={{ mb: 1 }}>ุงูุนูุฑ: {selectedNode.age} ุณูุฉ</Typography>}
              {/* ุฃุถู ูุฐุง ุงูุฌุฒุก ููุง - ุนุฏุฏ ุงูุฃุทูุงู */}
                    {(selectedNode.relation === 'ุฑุจ ุงูุนุงุฆูุฉ' && selectedNode.children && selectedNode.children.length > 0) && (
                      <Typography variant="body2" sx={{ mb: 1, color: '#4caf50', fontWeight: 'bold' }}>
                         ุนุฏุฏ ุงูุฃุทูุงู: {selectedNode.children.length}
                      </Typography>
                    )}

              {selectedNode.phone && <Typography variant="body2" sx={{ mb: 1 }}>ุงููุงุชู: {selectedNode.phone}</Typography>}
              {selectedNode.location && (
                <Typography variant="body2">ุงูููุงู: {selectedNode.location}</Typography>
              )}
            </Box>
          )}
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setSelectedNode(null)}>ุฅุบูุงู</Button>
        </DialogActions>
      </Dialog>
      
      <Snackbar 
        open={snackbarOpen} 
        autoHideDuration={4000} 
        onClose={() => setSnackbarOpen(false)}
        anchorOrigin={{ vertical: 'bottom', horizontal: 'center' }}
      >
        <Alert onClose={() => setSnackbarOpen(false)} severity={snackbarSeverity} sx={{ fontFamily: 'Cairo, sans-serif' }}>
          {snackbarMessage}
        </Alert>
      </Snackbar>

    </Box>
  );
}